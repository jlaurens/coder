% !TeX program=lualatex

\documentclass[10pt,a4paper]{article}

%\RequirePackage[
%  check-declarations,
%  enable-debug,
%]{expl3}

\usepackage{fontspec}
\usepackage{coder}
\RequirePackage{efbox}
\RequirePackage{mdframed}
\RequirePackage{luacode}
\usepackage{tcolorbox}

%
%
\ExplSyntaxOn
\prop_new:N \l_CDR_test_prop
\cs_new:Npn \cs #1 {\texttt{\textbackslash\tl_rescan:nn {\cctab_select:N \c_str_cctab} {#1}}}
\cs_new:Npn \CDRCmd #1 {\texttt{\tl_rescan:nn {\cctab_select:N \c_str_cctab} {#1}}}
\cs_set:Nn \CDR_helper:n {
  \typeout{KEY:#1}
}
\cs_set:Nn \CDR_helper:nn {
  \typeout{KV:#1->#2}
}
\ExplSyntaxOn
\makeatletter

\seq_new:N \l_CDR_fail_seq

\fp_zero_new:N \l_CDR_test_fp
\fp_zero_new:N \l_CDR_fail_fp

\fp_set:Nn \l_CDR_test_fp { 1 }


%    \end{macrocode}
% \begin{function}{\CDR_register_fail:}
% \begin{syntax}
% \cs{CDR_register_fail:}
% \end{syntax}
% Stores the current line and file to be processed by |\CDR_test:|
% \end{function}
%    \begin{macrocode}
\cs_new:Npn \CDR_register_fail: {
      \seq_put_right:Nn \l_CDR_fail_seq {\CDR@TEST:nn}
      \seq_put_right:Nx \l_CDR_fail_seq {\CurrentFile}
      \seq_put_right:Nn \l_CDR_fail_seq {\q_mark}
      \seq_put_right:Nx \l_CDR_fail_seq {\the\inputlineno}
      \seq_put_right:Nn \l_CDR_fail_seq {\q_stop}
}
\cs_new:Npn \CDR_assert_tl_empty:n #1 {
  \tl_if_empty:nF { #1 } {
    \fp_add:Nn \l_CDR_fail_fp { \l_CDR_test_fp }
    \CDR_register_fail:
  }
  \fp_set:Nn \l_CDR_test_fp {  2 * \l_CDR_test_fp }
}

%    \end{macrocode}
%
% \begin{function}{\CDR_test:cncn}
% \begin{syntax}
% \cs{CDR_test:cncn} \Arg{tag name} \Arg{type} \Arg{key} \Arg{value}
% \end{syntax}
% \end{function}
%    \begin{macrocode}
\cs_new:Npn \CDR_test:cncn #1 #2 #3 #4 {
  \use:c{#2_if_eq:xnF}
    { \CDR_tag_get:cc { #1 } { #3 } }
    { #4 }
    {
      \fp_add:Nn \l_CDR_fail_fp { \l_CDR_test_fp }
      \CDR_register_fail:
   }
  \fp_set:Nn \l_CDR_test_fp {  2 * \l_CDR_test_fp }
}

\cs_set:Npn \CDR@TEST:nn #1 \q_mark #2 \q_stop {
  \textbf{\color{red!50!black}FAILED:}~file~#1~at~line~#2\\
}

\prg_generate_conditional_variant:Nnn \skip_if_eq:nn { x } { p, T, F, TF }

\cs_new:Npn \CDR_test: {
  \fp_compare:nNnT \l_CDR_fail_fp > 0 { \CurrentFile : ERROR: \fp_use:N \l_CDR_fail_fp/\seq_count:N \l_CDR_fail_seq\\ }
  \seq_use:Nn \l_CDR_fail_seq {}
}

\makeatother
\ExplSyntaxOff

\newfontfamily\CDRVerbatimFont{TeX Gyre Cursor}[NFSSFamily=CDRVerbatimFont]
\newfontfamily\CDRMenloFont{Menlo}[NFSSFamily=menlo]

\begin{document}

\title{Testing the \textsf{coder} package}
\author{Jérôme LAURENS}
\maketitle

\section{Have \textsf{pygments}?}
\ExplSyntaxOn
\sys_get_shell:nnN {which~pygmentize} {} \l_CDR_tl
Path=\l_CDR_tl\\
\CDR_has_pygments:TF { WITH~PYGMENTS } { WITHOUT~PYGMENTS }\\
\sys_get_shell:nnN {which~python} {} \l_CDR_tl
Path=\l_CDR_tl\\
\ExplSyntaxOff

%\section{Sandbox}
%\makeatletter\ExplSyntaxOn
%\def\CDR@Debug { \use_none:n }
%\ExplSyntaxOff\makeatother
%%\input{Tests/Sandbox}
%\input{Tests/Engine}
%
%\end{document}

\section{Testing the tag mechanism}
\makeatletter\ExplSyntaxOn
\def\CDR@Debug { \use_none:n }
\ExplSyntaxOff\makeatother
\input{Tests/tag_mechanism}

\section{\cs{CDR_tag_choices_set:}}
\makeatletter\ExplSyntaxOn
\def\CDR@Debug { \use_none:n }
\ExplSyntaxOff\makeatother
\input{Tests/CDR_tag_choices_set}

\section{\cs{CDR_tag_boolean_set:}}
\makeatletter\ExplSyntaxOn
\def\CDR@Debug { \use_none:n }
\ExplSyntaxOff\makeatother
\input{Tests/CDR_tag_boolean_set}

\section{\texttt{int}}
\makeatletter\ExplSyntaxOn
\def\CDR@Debug { \use_none:n }
\ExplSyntaxOff\makeatother
\input{Tests/int}

\section{\cs{CDRSet}}
\makeatletter\ExplSyntaxOn
\def\CDR@Debug { \use_none:n }
\ExplSyntaxOff\makeatother
\input{Tests/keys}
\makeatletter\ExplSyntaxOn
\def\CDR@Debug { \use_none:n }
\ExplSyntaxOff\makeatother
\input{Tests/CDRSet}

\section{\cs{CDRCode}}
\makeatletter\ExplSyntaxOn
\def\CDR@Debug { \use_none:n }
\ExplSyntaxOff\makeatother
\input{Tests/CDRCode}

\section{\texttt{CDRBlock}}
\makeatletter\ExplSyntaxOn
\def\CDR@Debug { \use_none:n }
\ExplSyntaxOff\makeatother
\input{Tests/CDRBlock}

\section{\texttt{cache}}
\makeatletter\ExplSyntaxOn
\def\CDR@Debug { \use_none:n }
\ExplSyntaxOff\makeatother
\input{Tests/cache}

\section{\cs{CDRExport}}
\makeatletter\ExplSyntaxOn
\def\CDR@Debug { \use_none:n }
\ExplSyntaxOff\makeatother
\input{Tests/exportA}
\makeatletter\ExplSyntaxOn
\def\CDR@Debug { \use_none:n }
\ExplSyntaxOff\makeatother
\input{Tests/exportB,C,D}

\section{Engine}
\makeatletter\ExplSyntaxOn
\def\CDR@Debug { \use_none:n }
\ExplSyntaxOff\makeatother
\input{Tests/Engine}

\end{document}

