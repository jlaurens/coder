% !TeX program=lualatex
% !TeX root=../coder_test.tex
\noindent

\subsection{\textsf{fancyvrb} linear}

\bgroup
\makeatletter
\def\CDR@Debug#1{\typeout{**** DEBUG #1}}
\ExplSyntaxOn
\cs_set_protected_nopar:Npn \CDRBlock_teardown: {
\CDR@Debug{ \string \CDRBlock_teardown: }
  \bool_if:nT { \CDR_if_number_on_p: && !\CDR_if_dry_numbers_p: } {
    \tl_set:Nx \l_CDR_tl { \seq_count:N \l_CDR_vrb_seq }
    \clist_map_inline:Nn \g_CDR_tags_clist {
\CDR@Debug{ BEFORE, ##1, \CDR_int_use:c { ##1 } }
      \CDR_int_gadd:cn { ##1 } { \l_CDR_tl }
\CDR@Debug{ AFTER, ##1, \CDR_int_use:c { ##1 } }
    }    
  }
  \lua_now:n {
    CDR:hilight_block_teardown()
  }
}
\ExplSyntaxOff
\makeatother

\CDRSet{pygments=false}
KV:numbers=none,
\begin{Verbatim} [
  numbers=none,
]
A
\end{Verbatim}
KV:tags=none, numbers=none,
\begin{CDRBlock} [
  tags=none,
  numbers=none,
]
A
\end{CDRBlock}
\ExplSyntaxOn
\CDR_int_if_exist:cT { none } { \typeout { none ? FAILURE } }
\ExplSyntaxOff
\CDRSet{pygments=false,tags=none, numbers=left, firstnumber=last}
KV: tags=none, numbers=left, firstnumber=last,
\begin{CDRBlock}
none
2
3
\end{CDRBlock}
\ExplSyntaxOn
\typeout {tags = \g_CDR_tags_clist }
\CDR_int_if_exist:cF { none } { \typeout { none ? FAILURE } }
\typeout {none = \CDR_int_use:c { none } }
\ExplSyntaxOff
\begin{CDRBlock}
none:
5
6
\end{CDRBlock}
\ExplSyntaxOn
\typeout {none = \CDR_int_use:c { none } }
\ExplSyntaxOff
\begin{CDRBlock}
none
8
9
\end{CDRBlock}
\ExplSyntaxOn
\typeout {none = \CDR_int_use:c { none }}
\ExplSyntaxOff
\subsection{\pkg{pygments} linear}
\ExplSyntaxOn
\makeatletter
\makeatother
\ExplSyntaxOff

\CDRSet{pygments=true}
\begin{CDRBlock}
none
11
12
\end{CDRBlock}
\ExplSyntaxOn
\typeout {tags = \g_CDR_tags_clist }
\CDR_int_if_exist:cF { none } { \typeout { none ? FAILURE } }
\typeout {none = \CDR_int_use:c { none } }
\ExplSyntaxOff
\begin{CDRBlock}
none:
14
15
\end{CDRBlock}
\ExplSyntaxOn
\typeout {none = \CDR_int_use:c { none } }
\ExplSyntaxOff
\begin{CDRBlock}
none
17
18
\end{CDRBlock}
\egroup

\subsection{\pkg{fancyvrb} multi tags}

\bgroup

\CDRSet{pygments=false}

\begin{CDRBlock} [
  tags={A,B,C},
  numbers=left,
  firstnumber=last,
]
A=*1,B=1,C=1
\end{CDRBlock}

\begin{CDRBlock} [
  tags={B,C},
  numbers=left,
  firstnumber=last,
]
A=2,B=*2,C=2
A=2,B=*3,C=3
\end{CDRBlock}

\begin{CDRBlock} [
  tags=C,
  numbers=left,
  firstnumber=last,
]
A=2,B=4,C=*4
A=2,B=4,C=*5
\end{CDRBlock}

\begin{CDRBlock} [
  tags={C, B},
  numbers=left,
  firstnumber=last,
]
A=2,B=4,C=*6
A=2,B=5,C=*7
A=2,B=6,C=*8
\end{CDRBlock}

\begin{CDRBlock} [
  tags={B, A},
  numbers=left,
  firstnumber=last,
]
A=2,B=*7,C=9
A=3,B=*8,C=9
A=4,B=*9,C=9
\end{CDRBlock}
\begin{CDRBlock} [
  tags={A,C},
  numbers=left,
  firstnumber=last,
]
A=*5,B=10,C=9
A=*6,B=10,C=10
A=*7,B=10,C=11
\end{CDRBlock}

\ExplSyntaxOn
\CDR_int_compare:cNnF { A } = 8 { FAILED \\ }
\CDR_int_compare:cNnF { B } = {10} { FAILED \\ }
\CDR_int_compare:cNnF { C } = {12} { FAILED \\ }
\ExplSyntaxOff

\egroup

\subsection{\pkg{pygments} multi tags}

\bgroup

\CDRSet{
  pygments=true,
  numbers=left,
  firstnumber=last,
}
\begin{CDRBlock} [
  tags={D,E,F},
]
D=*1,E=1,F=1
\end{CDRBlock}

\begin{CDRBlock} [
  tags={E,F},
]
D=2,E=*2,F=2
D=2,E=*3,F=3
\end{CDRBlock}

\begin{CDRBlock} [
  tags=F,
]
D=2,E=4,F=*4
D=2,E=4,F=*5
\end{CDRBlock}

\begin{CDRBlock} [
  tags={F, E},
]
D=2,E=4,F=*6
D=2,E=5,F=*7
D=2,E=6,F=*8
\end{CDRBlock}

\begin{CDRBlock} [
  tags={E, D},
]
D=2,E=*7,F=9
D=3,E=*8,F=9
D=4,E=*9,F=9
\end{CDRBlock}
\begin{CDRBlock} [
  tags={D,F},
]
D=*5,E=10,F=9
D=*6,E=10,F=10
D=*7,E=10,F=11
\end{CDRBlock}

\ExplSyntaxOn
\CDR_int_compare:cNnF { A } = 8 { FAILED \\ }
\CDR_int_compare:cNnF { B } = {10} { FAILED \\ }
\CDR_int_compare:cNnF { C } = {12} { FAILED \\ }
\ExplSyntaxOff

\egroup
