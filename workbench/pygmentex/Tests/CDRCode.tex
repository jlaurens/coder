% !TeX program=lualatex
% !TeX root=../coder_test.tex
\noindent

\ExplSyntaxOn
\cs_new:Npn \CDR_process_line_code_append: { CDR_processline_code_append: }
\ExplSyntaxOff

\subsection{Fancyvrb basics}

\ExplSyntaxOn
\group_begin:

\cs_new:Npn \CDRVerbA #1 {
  \DefineShortVerb{#1}
  \SaveVerb[aftersave={\UndefineShortVerb{#1}},]{Verb}#1
}


\CDRVerbA!ABCD!



ABCDE
\UseVerb{Verb}

\CDRVerbA|ABCD|

\UseVerb{Verb}
\makeatletter
\NewDocumentCommand\Profco{O{}m}{
  \DefineShortVerb{#2}
  \SaveVerb[#1,aftersave={
    \UndefineShortVerb{#2}
    \mbox{\FV@UseKeyValues\FV@FormattingPrep\FV@SV@Verb}
    }
  ]{Verb}#2
}
\makeatother
\Profco|BCDG|

\UseVerb{Verb}

\group_end:
\ExplSyntaxOff
\bgroup
\begin{Verbatim}[
%  fontshape=b,
  fontfamily=CDRVerbatimFont,%tt,%helvetica, courier
  fontseries=b,
  fontsize=\large,
  showspaces=true,
  showtabs=true,
  tabsize=4,
  reflabel=verb0
]
First verba	tim line.
Second verbatim line.
\end{Verbatim}
See the verbatim on page~\pageref{verb0}
\\
\DefineShortVerb{\?}%
YYY%
\SaveVerb{ABC}?A B C?%
\UndefineShortVerb{\?}
\fvset{
fontfamily=menlo,
fontshape=it,
fontseries=auto,
fontsize=\Large,
}%
\UseVerb[showspaces]{ABC}%
YYY
\CDRSet{pygments=false}
\DefineShortVerb{\|}%
\SaveVerb{ABCE}|YY YY|%
\UndefineShortVerb{\|}
\UseVerb{ABCE}%

\egroup

\subsection{Coder}

\ExplSyntaxOn
\group_begin:

\makeatletter

\cs_new:Npn \CDR@Callback #1 #2 {
  \typeout{CDR@Callback:#1/#2/}
  \tl_if_empty:nF { #1 } {
    \input{#1}
    \CDR@StyleUseTag
  }
  \tl_if_empty:nF { #2 } {
    \input{#2}
  }
}

\cs_new:Npn \CDR@StyleInput #1 {
  \typeout{CDR@StyleInput:#1/}
  \input{#1}
  \CDR@StyleUseTag
}

\tl_new:N \l_CDR_style_tl
\cs_set:Npn \CDR_code:n #1 {
  \CDR_if_tag_truthy:cTF {pygments} {
    \cs_set:Npn \CDR@StyleUseTag {
      \CDR@StyleUse { \CDR_tag_get:c { style } }
      \cs_set_eq:NN \CDR@StyleUseTag \prg_do_nothing:
    }
    \CDR_keys_inherit:Vnn \c_CDR_tag { __local } {
      __fancyvrb,
    }
    \CDR_tag_keys_set:nV { __local } \l_CDR_keyval_tl
    \DefineShortVerb { #1 }
    \SaveVerb [
      aftersave = {
        \exp_args:Nx \UndefineShortVerb { #1 }
        \lua_now:n { CDR:hilight_code_prepare() }
        \CDR_tag_get:cN {lang} \l_CDR_tl
        \lua_now:n { CDR:hilight_set_var('lang') }
        \CDR_tag_get:cN {cache} \l_CDR_tl
        \lua_now:n { CDR:hilight_set_var('cache') }
        \CDR_tag_get:cN {debug} \l_CDR_tl
        \lua_now:n { CDR:hilight_set_var('debug') }
        \CDR_tag_get:cN {style} \l_CDR_style_tl
        \lua_now:n { CDR:hilight_set_var('style', 'l_CDR_style_tl') }
        \lua_now:n { CDR:hilight_set_var('source', 'FV@SV@CDR@Source') }
        \FV@UseKeyValues
        \frenchspacing
        %  \FV@SetupFont Break
        \FV@DefineWhiteSpace
        \FancyVerbDefineActive
        \FancyVerbFormatCom
        \CDR_code_format:
        \CDR_tag_get:c { format }
\typeout{DEBUG...................1.\CDR_tag_get:c { style }.\l_CDR_style_tl}
        \CDR@CodeEngineApply {
          \CDR@StyleIfExist { \l_CDR_style_tl } {
            \CDR@StyleUseTag
            \lua_now:n { CDR:hilight_source(false, true) }        
\typeout{DEBUG...................2A}
          } {
            \lua_now:n { CDR:hilight_source(true, true) }
\typeout{DEBUG...................2B}
          }
        }
\typeout{DEBUG...................3}
        \group_end:
      }
    ] { CDR@Source } #1
  } {
    \DefineShortVerb { #1 }
    \SaveVerb [
      aftersave = {
        \UndefineShortVerb { #1 }
        \cs_set_eq:NN \CDR@FormattingPrep \FV@FormattingPrep
        \cs_set:Npn \FV@FormattingPrep {
          \CDR@FormattingPrep
          \CDR_tag_get:c { format }
        }
        \CDR@CodeEngineApply { A \mbox { a
          \exp_args:NNV
          \def \FV@KeyValues \l_CDR_keyval_tl
          \FV@UseKeyValues
          \FV@FormattingPrep
          \@nameuse{FV@SV@CDR@Code}
        z } Z }
        \group_end:
      }
    ] { CDR@Code } #1
  }
}
%    \end{MacroCode}
%
%    \begin{MacroCode}[OK]
\RenewDocumentCommand \CDRCode { O{} } {
  \group_begin:
  \prg_set_conditional:Nnn \CDR_if_block: { p, T, F, TF } {
    \prg_return_false:
  }  
  \CDR_keys_inherit:Vnn \c_CDR_tag { __local } {
    __code, default.code, __pygments, default,
  }
  \CDR_tag_keys_set_known:nnN { __local } { #1 } \l_CDR_keyval_tl
  \CDR_tag_provide_from_keyval:V \l_CDR_keyval_tl
  \CDR_tag_keys_set_known:nVN { __local } \l_CDR_keyval_tl \l_CDR_keyval_tl
  \exp_args:NNV
  \def \FV@KeyValues \l_CDR_keyval_tl
  \CDR_keys_inherit:Vnn \c_CDR_tag { __local } {
    __fancyvrb,
  }
  \CDR_tag_keys_set:nV { __local } \l_CDR_keyval_tl  
  \CDR_tag_inherit:cf { __local } {
    \tl_if_empty:NF \l_CDR_tag_tl { \l_CDR_tag_tl, }
    __code, default.code, __pygments, default, __fancyvrb,
  }
  \fvset{showspaces}
  \CDR_code:n
}
\makeatother


\CDRSet{cache=false,debug=true}
\CDRSet{pygments=false}
A\\
\CDRCode|<fontsize=\Large>|\\
B\\
\CDRCode[fontsize=\Large]|<fontsize=\Large>|\\
\CDRSet{pygments=true}
A\\
\CDRCode|<fontsize=\Large>|\\
B\\
\CDRCode[fontsize=\Large]|<fontsize=\Large>|\\

\CDRCode!<ABC DEF>!\\
1\\
\CDRCode[fontfamily=menlo]!<fontfamily=menlo>!\\
2\\
\CDRCode[showspaces=true]!<showspaces = true>!\\
3\\
\CDRCode[fontsize=\Large]|<fontsize=\Large>|\\
4\\
\group_begin:
\cs_set:Npn \PackageError #1 #2 #3 {
\tl_to_str:n{\PackageError} #1\\
\exp_args:Ne \tl_to_str:n{#2}\\
\exp_args:Ne \tl_to_str:n{#3}\\
}
Expecting\space ERROR:\\
\CDRCode[engine=flower]|<engine=flower>|\\
\group_end:
5\\
\CDRCodeEngineNew{wave}{wavy(#2)}
\CDRCode[engine=wave]|<engine=wave>|\\
LAST\\
\CDRCode|<THIS IS THE LAST!!!>|\\
%
%\CDRCode|ABC DEF GHI|

\group_end:
\ExplSyntaxOff


\subsection{With pygments}

\begin{luacode}

tex.print('python=='..CDR.PYTHON_PATH)

local json = _ENV.utilities.json
local lfs   = _ENV.lfs

CDR.cache_clean_unused = function (self)
end

local load_exec = CDR.load_exec

CDR.Xload_exec = function (cmd)
print('CMD', cmd)
load_exec(cmd)
end
\end{luacode}


\CDRSet{python path=/usr/bin/python}
PATH==\directlua{tex.print(CDR.PYTHON_PATH)}\\
\CDRSet{python path=}
PATH==\directlua{tex.print(CDR.PYTHON_PATH)}\\

%  texopts.white_line_template = [[<placeholder:line>]]
%  texopts.black_line_template = [[
%    \CDR@Number{<placeholder:number>}<placeholder:line>]]
%  texopts.single_line_template = [[\CDR@Number{<placeholder:number>}<placeholder:line>]]
%  texopts.first_line_template = [[<placeholder:line>]]
%  texopts.second_line_template = [[<placeholder:line>]]
%  config['texopts'] = texopts
%  local fv_opts = {
%    ['__cls__'] = 'FVOpts'
%  }
%  config['fv_opts'] = fv_opts
%  local pyg_opts = {
%    ['__cls__'] = 'PygOpts'
%  }
%  config['pyg_opts'] = pyg_opts

\ExplSyntaxOn

\CDR_has_pygments:TF {
  PYGMENTS~TEST\\
} {
  NO~PYGMENTS~TEST
  \ExplSyntaxOff
  \endinput
}

\group_begin:
\CDRSet{pygments=true}

%\makeatletter
%
%\cs_gset:Npn \CDR_warning: {
%  \PackageWarning
%    { coder }
%    { pygments~support~IN~PROGRESS }
%  \cs_gset_eq:NN \CDR_warning: \prg_do_nothing:
%}
%\cs_set:Npn \CDR_code:n #1 {
%  \CDR_tag_inherit:cx { __local } {
%    \tl_if_empty:NF \l_CDR_tag_tl { \l_CDR_tag_tl, }
%    __code, default.code, default, __pygments, __fancyvrb,
%  }
%  \clist_clear:N \l_CDR_options_clist
%  \CDR_feed_options_clist:N \l_CDR_options_clist
%  \CDR_if_truthy:eTF { \CDR_tag_get:c {pygments} } {
%    \CDR_warning:
%    \DefineShortVerb { #1 }    
%    \SaveVerb [
%      aftersave = {
%        \UndefineShortVerb { #1 }
%        \lua_now:n { CDR:hilight_prepare() }
%        \CDR_tag_get:cN {style} \l_CDR_tl
%        \lua_now:n { CDR:hilight_set('style') }
%        \CDR_tag_get:cN {lang} \l_CDR_tl
%        \lua_now:n { CDR:hilight_set('lang') }
%        \lua_now:n { CDR:hilight_set('code', 'FV@SV@CDR@Code') }
%        \CDR_code_format:
%        \lua_now:n { CDR:hilight_code() }
%        \group_end:
%      }
%    ] { CDR@Code } #1
%  } {
%    \DefineShortVerb { #1 }
%    \SaveVerb [
%      aftersave = {
%        \UndefineShortVerb { #1 }
%        \CDR_code_fvset:
%        \CDR@CodeEngineApply { FANCYVRB:\UseVerb { CDR@Code } }
%        \group_end:
%      }
%    ] { CDR@Code } #1
%  }
%}
%\makeatother
\makeatletter
\makeatother

\CDRSet{pygments=false}
AB CD=\CDRCode|AB CD|\\
\CDRSet{pygments=true}
AB CD=\CDRCode|AB CD\textbf{AB}|\\
AB CD=\CDRCode[fontfamily=menlo]|AB CD\textbf{AB}|\\
AB CD=\CDRCode[formatcom=\color{red}]|AB CD\textbf{AB}|\\
AB CD=\CDRCode[format=\color{blue}]|AB CD\textbf{AB}|\\
AB CD=\CDRCode[format=\color{blue},formatcom=\color{red}]|AB CD\textbf{AB}|\\

\group_end:
\ExplSyntaxOff
\CDRSet{pygments=true,cache=false}
AB CD=\CDRCode|AB CD\textbf{AB}| et la suite\\
AB CD=\CDRCode[style=autumn]|AB CD\textbf{AB}| et la suite\\
AB CD=\CDRCode[cache=true]|AB CD\textbf{AB}| et la suite\\
AB CD=\CDRCode[cache=true,debug=true]|AB CD\textbf{AB}| et la suite\\
\ExplSyntaxOn
\group_begin:
\ExplSyntaxOff
\CDRSet{tag/X/style=autumn}
style autumn  AB CD=\CDRCode[tag=X]|AB CD\textbf{AB}| et la suite\\
style default AB CD=\CDRCode[tag=Y]|AB CD\textbf{AB}| et la suite\\
style default AB CD=\CDRCode[engine=efbox, efbox engine options={hidealllines,backgroundcolor=red}, engine options={backgroundcolor=yellow}]|AB CD\textbf{AB}| et la suite\\
style default AB CD=\CDRCode[format=\color{blue}]|AB CD\textbf{AB}| et la suite\\
\ExplSyntaxOn
\group_end:
\ExplSyntaxOff
\CDRSet{pygments=false}
