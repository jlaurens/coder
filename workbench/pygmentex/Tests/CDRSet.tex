% !TeX program=lualatex
% !TeX root=../coder_test.tex
Tests of \cs{CDRSet}
\noindent

\newcommand\meta[1]{{$\langle$}{\itshape #1}{$\rangle$}}

\subsection{\texttt{default}}
\ExplSyntaxOn
\group_begin:
\ExplSyntaxOff

\CDRSet{
  default engine options=DEFAULT,
  falbala engine options=FALBALA,
}

\ExplSyntaxOn

\CDR_test:cncn { default } { tl } { default~engine~options } { DEFAULT }
\CDR_test:cncn { default } { tl } { falbala~engine~options } { FALBALA }
\CDR_test:

\group_end:

\ExplSyntaxOff


\ExplSyntaxOn

\makeatletter
\def\CDR@Debug{\typeout}
\makeatother

\ExplSyntaxOff

\subsection{\texttt{tag/default}}
\ExplSyntaxOn
\group_begin:
\ExplSyntaxOff

\CDRSet {
  tag/default/engine = falbala,
  tag/default/default engine options=DEFAULT,
  tag/default/falbala engine options=FALBALA,
}

\ExplSyntaxOn
\CDR_test:cncn { default } { tl } { engine } { falbala }
\CDR_test:cncn { default } { tl } { default~engine~options } { DEFAULT }
\CDR_test:cncn { default } { tl } { falbala~engine~options } { FALBALA }

\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{__pygments}}
\ExplSyntaxOn
\group_begin:

TRUE==
\CDR_if_truthy:nTF { true } {
  TRUE
} {
  FALSE
}\\
FALSE==
\CDR_if_truthy:nTF { false } {
  TRUE
} {
  FALSE
}\\

\CDRSet{
  lang = A,
  pygments = B,
  style = C,
  commandprefix = D,
  mathescape = false,
  escapeinside = H,
}

\CDR_test:cncn { __pygments } { tl } { lang } { A }
\CDR_test:cncn { __pygments } { tl } { pygments } { false }
\CDR_test:cncn { __pygments } { tl } { style } { C }
\CDR_test:cncn { __pygments } { tl } { commandprefix } { D }
\CDR_test:cncn { __pygments } { tl } { mathescape } { false }
\CDR_test:cncn { __pygments } { tl } { escapeinside } { H }
\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{tag/<name>:__pygments}}
\ExplSyntaxOn
\group_begin:
%\makeatletter
%\def\CDR@Debug{\typeout}
%\makeatother
\CDRSet{
  tag/<name>/lang = A,
  tag/<name>/pygments = B,
  tag/<name>/style = C,
  tag/<name>/commandprefix = D,
  tag/<name>/mathescape = FAlsE,
  tag/<name>/escapeinside = H,
}

\CDR_test:cncn { <name> } { tl } { lang } { A }
\CDR_test:cncn { <name> } { tl } { pygments } { false }
\CDR_test:cncn { <name> } { tl } { style } { C }
\CDR_test:cncn { <name> } { tl } { commandprefix } { D }
\CDR_test:cncn { <name> } { tl } { mathescape } { false }
\CDR_test:cncn { <name> } { tl } { escapeinside } { H }
\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{__pygments.block}}
\ExplSyntaxOn
\group_begin:

\CDRSet{
  texcomments = A,
  texcomments = FALSe,
}

\CDR_test:cncn { __pygments.block } { tl } { texcomments} { false }
\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{tag/<name>:__pygments.block}}

\ExplSyntaxOn
\group_begin:
\ExplSyntaxOff

\CDRSet{
  tag/N/stepnumber = 5,
}

\CDRSet{
  tag/<name>/texcomments = A,
  tag/<name>/texcomments = FALse,
}

\ExplSyntaxOn
\CDR_test:cncn { <name> } { tl } { texcomments } { false }
\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{default.code}}
\ExplSyntaxOn
\group_begin:

\CDRSet{
}

\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{tag/<name>:default.code}}
\ExplSyntaxOn
\group_begin:

\CDRSet{
}

\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{default.block}}
\ExplSyntaxOn
\group_begin:

\CDRSet{
    show~tags = left,
    only~top = true,
    use~margin = false,
    tags~format = H,
}

\CDR_test:cncn { default.block } { tl } { show~tags } { left }
\CDR_test:cncn { default.block } { tl } { only~top } { true }
\CDR_test:cncn { default.block } { tl } { use~margin } { false }
\CDR_test:cncn { default.block } { tl } { tags~format } { H }
\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{tag/<name>:default.block}}

\ExplSyntaxOn
\group_begin:

\def\CDR@Debug#1{
\typeout{****~Debug~#1}
}
\RenewDocumentCommand \CDRSet { m } {
\CDR@Debug{\string\CDRSet}
  \CDR_set_preflight:n { #1 }
  \keys_set_known:nnnN { CDR@Set } { #1 } { CDR@Set } \l_CDR_kv_clist
  \clist_map_inline:nn {
    __pygments, __pygments.block,
    __tags, __engine, default.block, default.code, default,
    __fancyvrb, __fancyvrb.frame, __fancyvrb.block, __fancyvrb.number, __fancyvrb.all
  } {
    \CDR_tag_keys_set_known:nVN { ##1 } \l_CDR_kv_clist \l_CDR_kv_clist
\CDR@Debug{ \string\CDRSet.1:##1/\l_CDR_kv_clist/ }
  }
  \CDR_tag_keys_set_known:nVN { .. } \l_CDR_kv_clist \l_CDR_kv_clist
\CDR@Debug{ \string\CDRSet.2:\CDR_tag_module:n { .. }//\l_CDR_kv_clist/ }
  \CDR_tag_provide_from_kv:V \l_CDR_kv_clist
\CDR@Debug{ \string\CDRSet.2a:\CDR_tag_module:n { .. }//\l_CDR_kv_clist/ }  
  \CDR_tag_keys_set_known:nVN { .. } \l_CDR_kv_clist \l_CDR_kv_clist
\CDR@Debug{ \string\CDRSet.3:\CDR_tag_module:n { .. }//\l_CDR_kv_clist/ }
  \CDR_tag_keys_set:nV { default } \l_CDR_kv_clist
\CDR@Debug{ \string\CDRSet.4:\CDR_tag_module:n { default } /\l_CDR_kv_clist/ }
  \keys_define:nn { CDR@Set@tags } {
    tags .code:n = {
      \clist_set:Nn \g_CDR_tags_clist { ##1 }
      \clist_remove_duplicates:N \g_CDR_tags_clist
    },
  }
  \keys_set_known:nn { CDR@Set@tags } { #1 }
}

\CDRSet{
    tag/<name>/tags = A,
    tag/<name>/show~tags = right,
    tag/<name>/only~top = true,
    tag/<name>/use~margin = false,
    tag/<name>/tags~format = H,
    tag/<name>/vspace = \topsep,
}

\CDR_test:cncn { <name> } { tl } { tags } { A }
\CDR_test:cncn { <name> } { tl } { show~tags } { right }
\CDR_test:cncn { <name> } { tl } { only~top } { true }
\CDR_test:cncn { <name> } { tl } { use~margin } { false }
\CDR_test:cncn { <name> } { tl } { tags~format } { H }
\CDR_test:cncn { <name> } { skip } { vspace } { \topsep }
\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{__fancyvrb}}
\ExplSyntaxOn
\group_begin:

\CDRSet{
    formatcom = A,
    fontfamily = B,
    fontsize = C,
    fontshape = D,
    fontseries = DD,
    showspaces = true,
    showtabs = false,
    obeytabs = true,
    tabsize = 4,
    defineactive = E,
    reflabel = F,
}
\prop_set_from_keyval:Nn \l_CDR_test_prop {
    formatcom = A,
    fontfamily = B,
    fontsize = C,
    fontshape = D,
    fontseries = DD,
    showspaces = true,
    showtabs = false,
    obeytabs = true,
    tabsize = 4,
    defineactive = E,
    reflabel = F,
}
\prop_map_inline:Nn \l_CDR_test_prop {
  \CDR_test:cncn { __fancyvrb } { tl } { #1 } { #2 }
}
\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{tag/<name>:__fancyvrb}}
\ExplSyntaxOn
\group_begin:

\CDRSet{
    tag/<name>/formatcom = A,
    tag/<name>/fontfamily = B,
    tag/<name>/fontsize = C,
    tag/<name>/fontshape = D,
    tag/<name>/showspaces = true,
    tag/<name>/showtabs = false,
    tag/<name>/obeytabs = true,
    tag/<name>/tabsize = 4,
    tag/<name>/defineactive = E,
    tag/<name>/reflabel = F,
}

\prop_set_from_keyval:Nn \l_CDR_test_prop {
    formatcom = A,
    fontfamily = B,
    fontsize = C,
    fontshape = D,
    showspaces = true,
    showtabs = false,
    obeytabs = true,
    tabsize = 4,
    defineactive = E,
    reflabel = F,
}
\prop_map_inline:Nn \l_CDR_test_prop {
  \CDR_test:cncn { <name> } { tl } { #1 } { #2 }
}
\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{__fancyvrb.block}}
\ExplSyntaxOn
\group_begin:

\CDRSet{
    commentchar = A,
    gobble = 0,
    baselinestretch = auto,
    resetmargins = true,
    xleftmargin = 0pt,
    xrightmargin = 0pt,
    hfuzz = 2pt,
    vspace = 2.34 \baselineskip,
    samepage = false,
}
\prop_set_from_keyval:Nn \l_CDR_test_prop {
    commentchar = A,
    gobble = 0,
    baselinestretch = auto,
    resetmargins = true,
    xleftmargin = 0pt,
    xrightmargin = 0pt,
    hfuzz = 2pt,
    vspace = 2.34 \baselineskip,
    samepage = false,
}
\prop_map_inline:Nn \l_CDR_test_prop {
  \CDR_test:cncn { __fancyvrb.block } { tl } { #1 } { #2 }
}
\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{__fancyvrb.frame}}
\ExplSyntaxOn
\group_begin:

\CDRSet{
    commentchar = A,
    gobble = 0,
    frame = none,
    label = B,
    labelposition = none,% auto?
    numbers = left,
    numbersep = \hspace{1ex},
    firstnumber = auto,
    stepnumber = 1,
    numberblanklines = true,
    firstline = C,
    lastline = D,
    baselinestretch = auto,
    resetmargins = true,
    xleftmargin = 0pt,
    xrightmargin = 0pt,
    hfuzz = 2pt,
    samepage = false,
}
\prop_set_from_keyval:Nn \l_CDR_test_prop {
    frame = none,
    label = B,
    labelposition = none,% auto?
}
\prop_map_inline:Nn \l_CDR_test_prop {
  \CDR_test:cncn { __fancyvrb.frame } { tl } { #1 } { #2 }
}
\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{__fancyvrb.number}}
\ExplSyntaxOn
\group_begin:

\CDRSet{
    numbers = right,
    numbersep = 1.23ex,
    firstnumber = last,
    stepnumber = 421,
    numberblanklines = false,
    firstline = first,
    lastline = last,
}
\prop_set_from_keyval:Nn \l_CDR_test_prop {
    numbers = right,
    numbersep = 1.23ex,
    firstnumber = last,
    stepnumber = 421,
    numberblanklines = false,
    firstline = first,
    lastline = last,
}
\prop_map_inline:Nn \l_CDR_test_prop {
  \CDR_test:cncn { __fancyvrb.number } { tl } { #1 } { #2 }
}
\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{tag/<name>:__fancyvrb.block}}
\ExplSyntaxOn
\group_begin:

\makeatletter
\def\CDR@Debug{\typeout}
\makeatother

\CDRSet{
    tag/<name>/commentchar = A,
    tag/<name>/gobble = 0,
    tag/<name>/frame = none,
    tag/<name>/label = B,
    tag/<name>/labelposition = none,% auto?
    tag/<name>/numbers = left,
    tag/<name>/numbersep = \hspace{1ex},
    tag/<name>/firstnumber = auto,
    tag/<name>/stepnumber = 1,
    tag/<name>/numberblanklines = true,
    tag/<name>/firstline = C,
    tag/<name>/lastline = D,
    tag/<name>/baselinestretch = auto,
    tag/<name>/resetmargins = true,
    tag/<name>/xleftmargin = 0pt,
    tag/<name>/xrightmargin = 0pt,
    tag/<name>/hfuzz = 2pt,
    tag/<name>/samepage = false,
}
\prop_set_from_keyval:Nn \l_CDR_test_prop {
    commentchar = A,
    gobble = 0,
    frame = none,
    label = B,
    labelposition = none,% auto?
    numbers = left,
    numbersep = \hspace{1ex},
    firstnumber = auto,
    stepnumber = 1,
    numberblanklines = true,
    firstline = C,
    lastline = D,
    baselinestretch = auto,
    resetmargins = true,
    xleftmargin = 0pt,
    xrightmargin = 0pt,
    hfuzz = 2pt,
    samepage = false,
}
\prop_map_inline:Nn \l_CDR_test_prop {
  \CDR_test:cncn { <name> } { tl } { #1 } { #2 }
}
\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{__fancyvrb.all}}
\ExplSyntaxOn
\group_begin:

\CDRSet{
    commandchars = A,
    codes = B,
  }
\prop_set_from_keyval:Nn \l_CDR_test_prop {
    commandchars = A,
    codes = B,
  }
\prop_map_inline:Nn \l_CDR_test_prop {
  \CDR_test:cncn { __fancyvrb.all } { tl } { #1 } { #2 }
}
\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{tag/<name>:__fancyvrb.all}}
\ExplSyntaxOn
\group_begin:

\CDRSet{
    tag/<name>/commandchars = A,
    tag/<name>/codes = B,
  }
\prop_set_from_keyval:Nn \l_CDR_test_prop {
    commandchars = A,
    codes = B,
  }
\prop_map_inline:Nn \l_CDR_test_prop {
  \CDR_test:cncn { <name> } { tl } { #1 } { #2 }
}
\CDR_test:

\group_end:
\ExplSyntaxOff


\subsection{\CDRCmd{__tags}}
\ExplSyntaxOn
\group_begin:

\CDRSet{
    tags = A,
  }
\prop_set_from_keyval:Nn \l_CDR_test_prop {
    tags = A,
  }
\prop_map_inline:Nn \l_CDR_test_prop {
  \CDR_test:cncn { __tags } { tl } { #1 } { #2 }
}
\CDR_test:

\group_end:
\ExplSyntaxOff

\subsection{\CDRCmd{__engine}}
\ExplSyntaxOn
\group_begin:

\CDRSet{
    engine = A,
  }
\prop_set_from_keyval:Nn \l_CDR_test_prop {
    engine = A,
  }
\prop_map_inline:Nn \l_CDR_test_prop {
  \CDR_test:cncn { __engine } { tl } { #1 } { #2 }
}
\CDR_test:

\group_end:
\ExplSyntaxOff

