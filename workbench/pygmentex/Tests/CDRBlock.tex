% !TeX program=lualatex
% !TeX root=../coder_test.tex
\noindent

\ExplSyntaxOn
\CDR_int_new:cn { __last } { 0 }
\keys_define:nn { CDR@Line } {
  last .code:n = \CDR_int_set:cn { __last } { #1 },
}
\cs_new:Npn \CDR_typeout:n { \use_none:n }

\ExplSyntaxOff

\ExplSyntaxOn
\cs_set:Npn \CDR_block_preflight:n #1 {
  \clist_if_empty:nF { #1 } {
    \par\noindent Block~options:
    \begin{itemize}
    \ttfamily
    \clist_map_inline:nn { #1 } {
      \item \tl_to_str:n { ##1 }
    }
    \end{itemize}
  }
}
\cs_set:Npn \CDR_set_preflight:n #1 {
  \clist_if_empty:nF { #1 } {
    \par\noindent CDRSet:
    \begin{itemize}
    \ttfamily
    \clist_map_inline:nn { #1 } {
      \item \tl_to_str:n { ##1 }
    }
    \end{itemize}
  }
}
\ExplSyntaxOff



%\bgroup
%
%%
%ESSAI
%\begin{Verbatim}
%[]
%ESSAI
%\end{Verbatim}
%
%\makeatletter
%\def\FVB@MyVerbatim{
%\FV@VerbatimBegin\FV@Scan
%}
%\def\FVE@MyVerbatim{
%\FV@VerbatimEnd
%}
%\makeatother
%\DefineVerbatimEnvironment{MyVerbatim}{MyVerbatim}{}
%
%
%\begin{MyVerbatim}[fontsize=\Large]
%ESSAI
%\end{MyVerbatim}
%
%
%\ExplSyntaxOn
%\makeatletter
%
%\cs_new:Npn \CDR_hilight_record:n #1 {
%}
%
%\def\CDR@ListProcessLine#1{%
%  \hbox to \hsize{#1
%}%
%}
%
%
%
%% \begin{variable}{\l_CDR_pyg_bool}
%%    \begin{MacroCode}[OK]
%\bool_new:N \l_CDR_pyg_bool
%\bool_set_false:N \l_CDR_pyg_bool
%%    \end{MacroCode}
%% \end{variable}
%%
%
%\prg_set_conditional:Nnn \CDR_tag_if_truthy:c { p, T,  F, TF } {
%  \exp_args:Ne
%  \str_compare:nNnTF {
%    \exp_args:Ne \str_lowercase:n { \CDR_tag_get:c { #1 } }
%  } = { false } {
%    \prg_return_false:
%  } {
%    \prg_return_true:
%  }
%}
%
%\cs_new:Npn \CDR@Line {
%  \peek_meaning_ignore_spaces:NTF [ { \CDR_line:nnn } { \CDR_line:nn }
%}
%\cs_new:Npn \CDR_line:nnn [ #1 ] {
%  \keys_set:nn { CDR@Line } { #1 }
%  \CDR_line:nn
%}
%\cs_new:Npn \CDR_line:nn #1 #2 {
%  \CDR_typeout:n {CDR@Line:\the\leftmargin/#1/}
%  \hbox to \hsize {
%    \kern \leftmargin
%    \CDR_info_L:n { #1 }
%    \hbox to \linewidth {
%      \FV@LeftListFrame
%      #2
%      \hss
%      \FV@RightListFrame
%    }
%  }
%}
%
%\cs_new:Npn \CDR@NumberFormat {
%  \CDR_tag_get:c { numbers~format }
%}
%\cs_new:Npn \CDR@TagsFormat {
%  \CDR_tag_get:c { tags~format }
%}
%\cs_new:Npn \CDR@NumberSep {
%  \hspace{ \CDR_tag_get:c { numbersep } }
%}
%
%%    \end{MacroCode}
%% \begin{function}{\FVB@CDRBlock}
%% \pkg{fancyvrb} helper to begin the environment.
%% \end{function}
%%    \begin{MacroCode}
%
%\ExplSyntaxOff
%
%\makeatother
%\begin{luacode}
%
%function CDR:cache_clean_unused()
%end
%
%\end{luacode}
%%
%\begin{CDRBlock}[
%  tags=,
%  fontfamily=menlo,
%  fontsize=\Large,
%  pygments=false,
%  lang=lua,
%  numbers=left,
%  frame=lines,
%  format=\color{green},
%  debug=true,
%  showspaces
%]
%local f = function(arg)
%  return arg ** arg
%end
%\end{CDRBlock}
%\CDR_typeout:n {IN PROGRESSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS}
%Next should not be void
%\CDRSet{cache=false}
%\begin{CDRBlock}[
%  tags=,
%  fontfamily=menlo,
%  fontsize=\large,
%  pygments=true,
%  lang=python,
%  numbers=left,
%  frame=single,
%  debug=true,
%]
%def foo(arg):
%  return arg ** arg
%\end{CDRBlock}
%
%Next should not be void
%\CDRSet{cache=false}
%\begin{CDRBlock}[
%  tags=,
%  fontfamily=menlo,
%  fontsize=\large,
%  pygments=true,
%  lang=lua,
%  numbers=left,
%  frame=lines,
%  debug=true,
%  frame=single,
%  framerule=1mm,
%  framesep=3mm,
%  rulecolor=\color{red},
%  fillcolor=\color{yellow},
%  showspaces,
%  baselinestretch=1.75
%]
%function foo(arg)
%  return arg ** arg
%end
%\end{CDRBlock}
%
%\egroup

\subsection{Line numbering}

\bgroup

\makeatletter
\ExplSyntaxOn


\cs_set:Npn \CDR@NumberFormat {
  \CDR_tag_get:c { numbers~format }
}
\cs_set:Npn \CDR@NumberSep {
  \hspace{ \CDR_tag_get:c { numbersep } }
}


%    \end{MacroCode}
%
% \begin{function}{\CDR_block_setup_tags:}
% Utility to setup the tags and the tag inheritance tree.
% \end{function}
%    \begin{MacroCode}
\cs_new:Npn \CDR_block_setup_tags: {
\CDR_typeout:n {STEP2}
  \CDR_tag_if_exist_here:ccT { __local } { tags } {
    \CDR_tag_get:cN { tags } \l_CDR_clist
    \clist_if_empty:NF \l_CDR_clist {
      \clist_gset_eq:NN \g_CDR_tags_clist \l_CDR_clist
    }
  }
  \clist_if_empty:NT \g_CDR_tags_clist {
    \PackageWarning
      { coder }
      { No~(default)~tags~provided. }
  }
  \CDR_tag_inherit:cf { __local } {
    \g_CDR_tags_clist,
    __block, default.block, __pygments.block, __fancyvrb.block, __fancyvrb.number,
     __pygments, default, __fancyvrb,
  }
  
%    \end{MacroCode}
% Create a |\CDR_tags_if_already[_p]:...| conditionals.
%    \begin{MacroCode}
  \bool_if:nTF {
    \CDR_tag_if_truthy_p:c { only~top } &&
    \CDR_clist_if_eq_p:NN \g_CDR_tags_clist \g_CDR_last_tags_clist
  } {
    \tl_set:Nn \l_CDR_tl { \prg_return_false: }
  } {
    \tl_set:Nn \l_CDR_tl { \prg_return_true:  }
  }
  \exp_args:NNnV
  \prg_set_conditional:Nnn \CDR_tags_if_already: { p, T, F, TF } \l_CDR_tl
%    \end{MacroCode}
% Create a |\CDR_tags_if_visible[_p]:n...| conditionals, the mandatory argument is one of
% |left| or |right|.
%    \begin{MacroCode}
  \prg_set_conditional:Nnn \CDR_tags_if_visible:n { p, T, F, TF } {
    \bool_if:nTF {
      ( \CDR_tag_if_eq_p:cn { show~tags } { ##1 } ||
        \CDR_tag_if_eq_p:cn { show~tags } { numbers } &&
        \CDR_tag_if_eq_p:cn { numbers } { ##1 }
      ) &&
      ( ! \CDR_tag_if_truthy_p:c { only~top } ||
        ! \CDR_clist_if_eq_p:NN \g_CDR_tags_clist \g_CDR_last_tags_clist
      )
    } {
      \prg_return_true:
    } {
      \prg_return_false:
    }
  }
%    \end{MacroCode}
% For each \metatt{tag name}, create an \pkg{l3int} variable and initialize it to 1.
%    \begin{MacroCode}
  \clist_map_inline:Nn \g_CDR_tags_clist {
    \CDR_int_if_exist:cF { ##1 } {
      \CDR_int_new:cn { ##1 } { 1 }
    }
  }
}
%    \end{MacroCode}
%
% \begin{function}{\FVB@CDRBlock}
% \pkg{fancyvrb} helper to begin the environment.
% \end{function}
%    \begin{MacroCode}
\def\FVB@CDRBlock {
  \@bsphack
  \group_begin:
\CDR_typeout:n {STEP0, \FV@KeyValues}
  \exp_args:NV \CDR_block_preflight:n \FV@KeyValues
  \prg_set_conditional:Nnn \CDR_if_block: { p, T, F, TF } {
    \prg_return_true:
  }  
  \CDR_tag_keys_set:nn { __block } { __initialize }
\CDR_typeout:n {STEP1, \l_CDR_kv_clist}
%    \end{MacroCode}
% Reading the options: we absorb the options available in |\FV@KeyValues|,
% first for % \pkg{l3keys} modules, then for |\fvset|.
%    \begin{MacroCode}
  \CDR_keys_inherit:Vnn \c_CDR_tag { __local } {
    __block, __pygments.block, default.block,
    __pygments, default,
  }
  \CDR_tag_keys_set_known:nVN { __local } \FV@KeyValues \l_CDR_kv_clist
  \CDR_tag_provide_from_kv:V \l_CDR_kv_clist
  \CDR_tag_keys_set_known:nVN { __local } \l_CDR_kv_clist \l_CDR_kv_clist
%    \end{MacroCode}
% By default, this code chunk will have the same list of tags
% as the last code block or last |\CDRExport| stored in |\g_CDR_tags_clist|.
% This can be overwritten with the |tags=...| user interface.
% At least one tag must be provided.
%    \begin{MacroCode}
  \CDR_block_setup_tags:
\CDR_typeout:n {STEP1e, \l_CDR_kv_clist}
  \lua_now:n {
    CDR:hilight_block_setup('g_CDR_tags_clist')
  }
%    \end{MacroCode}
% |\l_CDR_pyg_bool| is |true| iff one of the tags needs \pkg{pygments} or there is no tag and |pygments=true| was given.
%    \begin{MacroCode}
  \bool_set_false:N \l_CDR_pyg_bool
  \bool_set:Nn \l_CDR_pyg_bool {
    \CDR_tag_if_truthy_p:c { pygments }
  }
\CDR_typeout:n {STEP1}
%    \end{MacroCode}
% And we can setup the engine.
%    \begin{MacroCode}
  \CDR_tag_get:cN { engine } \l_CDR_engine_tl
  \CDR_if_code_engine:VF \l_CDR_engine_tl {
    \PackageError
      { coder }
      { \l_CDR_engine_tl\space block~engine~unknown,~replaced~by~'default' }
      {See~\CDRBlockEngineNew~in~the~coder~manual}
    \tl_set:Nn \l_CDR_engine_tl { default }
  }
  \CDR_tag_get:cN { \l_CDR_engine_tl~engine~options } \l_CDR_opts_tl
  \CDR_tag_get:cN { engine~options } \l_CDR_tl
  \tl_if_empty:NF \l_CDR_tl {
    \tl_put_right:Nn \l_CDR_opts_tl {,}
    \tl_put_right:NV \l_CDR_opts_tl \l_CDR_tl
  }
  \exp_args:NnV
  \use:c { \CDR_block_engine:V \l_CDR_engine_tl } \l_CDR_opts_tl
%    \end{MacroCode}
% Now we branch according whether \pkg{pygments} is used or not.
%    \begin{MacroCode}
\CDR_typeout:n {STEP1}
  \bool_if:NTF \l_CDR_pyg_bool {
    \CDRBlock@Pyg
  } {
    \CDRBlock@FV
  }
  \FV@Scan
}
\def\FVE@CDRBlock {
  \bool_if:NTF \l_CDR_pyg_bool {
    \endCDRBlock@Pyg
  } {
    \endCDRBlock@FV
  }
  \use:c { end \CDR_block_engine:V \l_CDR_engine_tl }
  \group_end:
  \@esphack
}
\DefineVerbatimEnvironment{CDRBlock}{CDRBlock}{}

\cs_new:Npn \CDRBlockOptions { \exp_last_unbraced:NnV }

\newenvironment { CDRBlock@Pyg } {
\CDR_typeout:n {DEBUG:PYGMENTS}
%    \end{MacroCode}
% Catch the keys related to numbering before they are forwarded to \pkg{fancyvrb}.
%    \begin{MacroCode}
  \CDR_keys_inherit:Vnn \c_CDR_tag { __local } {
    __fancyvrb.number
  }
  \CDR_tag_keys_set_known:nVN { __local } \l_CDR_kv_clist \l_CDR_kv_clist
  \CDR_keys_inherit:Vnn \c_CDR_tag { __local } {
    __fancyvrb, __fancyvrb.block
  }
\CDR_typeout:n {KEYS:\l_CDR_kv_clist}
  \exp_args:NnV
  \CDR_tag_keys_set:nn { __local } \l_CDR_kv_clist
  \exp_args:NNV
  \def \FV@KeyValues \l_CDR_kv_clist
  \CDR_tag_if_eq:cnTF { numbers } { none } {
    \tl_set:Nn \l_CDR_tl { \prg_return_false: }
  } {
    \tl_set:Nn \l_CDR_tl { \prg_return_true: }
  }
  \exp_args:NNnV
  \prg_set_conditional:Nnn \CDR_if_number_on: { p, T, F, TF } \l_CDR_tl
%    \end{MacroCode}
% Get the list of tags and setup \CDRLua{} for recording or hilighting.
%    \begin{MacroCode}
  \CDR_tag_get:cN {lang} \l_CDR_tl
  \lua_now:n { CDR:hilight_set_var('lang') }
  \CDR_tag_get:cN {cache} \l_CDR_tl
  \lua_now:n { CDR:hilight_set_var('cache') }
  \CDR_tag_get:cN {debug} \l_CDR_tl
  \lua_now:n { CDR:hilight_set_var('debug') }
  \CDR_tag_get:cN {style} \l_CDR_tl
  \lua_now:n { CDR:hilight_set_var('style') }
  \CDR@StyleIfExist { \l_CDR_tl } { } {
    \lua_now:n { CDR:hilight_source(true, false) }
    \input { \l_CDR_pyg_sty_tl }
  }
  \CDR@StyleUseTag
  \CDR_tag_if_truthy:cTF {no~export} {
    \clist_map_inline:nn { i, ii, iii, iv } {
      \cs_set:cpn { FV@ListProcessLine@ ##1 } ####1 {
        \tl_set:Nn \l_CDR_tl { ####1 }
        \lua_now:n { CDR:record_line('l_CDR_tl') }
      }
    }
  } {
    \clist_map_inline:nn { i, ii, iii, iv } {
      \cs_set:cpn { FV@ListProcessLine@ ##1 } ####1 {
        \tl_set:Nn \l_CDR_tl { ####1 }
        \lua_now:n { CDR:record_line('l_CDR_tl') }
      }
    }
  }
  \def\FV@ProcessLine ##1 {
    \tl_set:Nn \l_CDR_tl { ##1 }
    \lua_now:n { CDR:record_line('l_CDR_tl') }
  }
} {
  \CDR_if_number_on:T {
    \clist_map_inline:Nn \g_CDR_tags_clist {
      \CDR_int_if_exist:cF { ##1 } {
        \CDR_int_new:cn { ##1 } { 1 }
      }
    }
  }
  \CDR_tag_get:c { format }
  \fvset{ commandchars=\\\{\} }
  \CDR@DefineSp
  \FV@VerbatimBegin
  \lua_now:n { CDR:hilight_source(false, true) }
  \makeatletter
  \input{ \l_CDR_pyg_tex_tl }
  \makeatother
  \CDR_if_number_on:T {
    \CDR_int_add:cn { __last } { 1 }
    \clist_map_inline:Nn \g_CDR_tags_clist {
      \CDR_int_gset:cc { ##1 } { __last }
    }
  }
  \FV@VerbatimEnd
}

\newenvironment { CDRBlock@FV } {
\CDR_typeout:n {DEBUG:FV}
%    \end{MacroCode}
% \pkg{pygments} is not used, \pkg{fancyvrb} features.
% We record the key value options about numbering.
%    \begin{MacroCode}
  \exp_args:NnV
  \use:c { \CDR_block_engine:V \l_CDR_engine_tl } \l_CDR_opts_tl
  \CDR_keys_inherit:Vnn \c_CDR_tag { __local } {
    __fancyvrb.number,
  }
  \CDR_tag_keys_set_known:nVN { __local } \l_CDR_kv_clist \l_CDR_clist
  \CDR_tag_inherit:cn { __local } {
    __fancyvrb.number,
    __block,
  }
  \CDR_tag_if_eq:cnTF { numbers } { none } {
    \tl_set:Nn \l_CDR_tl { \prg_return_false: }
  } {
    \tl_set:Nn \l_CDR_tl { \prg_return_true: }
  }
  \exp_args:NNnV
  \prg_set_conditional:Nnn \CDR_if_number_on: { p, T, F, TF } \l_CDR_tl  
  \CDR_tag_if_truthy:cF {no~export} {
    \clist_map_inline:nn { i, ii, iii, iv } {
      \cs_set:cpn { FV@ListProcessLine@ ##1 } ####1 {
        \tl_set:Nn \l_CDR_tl { ####1 }
        \lua_now:n { CDR:record_line('l_CDR_tl') }
        \use:c { CDR@ListProcessLine@ ##1 } { ####1 }
      }
    }
  }
%    \end{MacroCode}
% Prepare the counters. The |__| int starts with 0, which means that it is unused.
% If the |firstnumber| value is ``last'' then it is used to store the first number.
%    \begin{MacroCode}
  \CDR_int_set:cn { __ } { 0 }
\CDR_typeout:n {NUMBERING...}
  \CDR_if_number_on:T {
\CDR_typeout:n {...ON}
    \CDR_tag_if_eq:cnT { firstnumber } { last } {
      \clist_map_inline:Nn \g_CDR_tags_clist {
        \clist_map_break:n {
          \CDR_int_set:cc { __ } { ##1 }
          \clist_put_right:Nx \l_CDR_kv_clist {
            firstnumber = \CDR_int_use:c { ##1 }
          }
        }
      }
    }
  }
  \exp_args:NNV
  \def \FV@KeyValues \l_CDR_kv_clist
  \FV@VerbatimBegin
} {
  \FV@VerbatimEnd
  \CDR_if_number_on:T {
    \CDR_int_compare:cNnTF { __ } > 0 {
      \CDR_int_set:cn { __ } {
        \value{FancyVerbLine} - \CDR_int_use:c { __ } + 1
      }
      \clist_map_inline:Nn \g_CDR_tags_clist {
        \CDR_int_gadd:cc { ##1 } { __ }
      }
    } {
      \CDR_int_set:cn { __ } { \value{FancyVerbLine} + 1 }
      \clist_map_inline:Nn \g_CDR_tags_clist {
        \CDR_int_gset:cc { ##1 } { __ }
      }
    }
  }
}

\prg_new_conditional:Nnn \CDR_clist_if_eq:NN { p, T, F, TF } {
  \tl_if_eq:NNTF #1 #2 {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}

\ExplSyntaxOff
\makeatother

\subsubsection{\textsf{fancyvrb} linear}

\bgroup

\CDRSet{pygments=false}

\begin{Verbatim} [
  numbers=none,
]
A
\end{Verbatim}

\begin{CDRBlock} [
  tags=none,
  numbers=none,
]
A
\end{CDRBlock}

\ExplSyntaxOn
\CDR_int_if_exist:cT { none } { \CDR_typeout:n { none ? FAILURE } }
\ExplSyntaxOff

\begin{CDRBlock} [
  tags=none,
  numbers=left,
  firstnumber=last,
]
A
B
C
\end{CDRBlock}
\ExplSyntaxOn
\CDR_typeout:n {tags = \g_CDR_tags_clist }
\CDR_int_if_exist:cF { none } { \CDR_typeout:n { none ? FAILURE } }
\CDR_typeout:n {none = \CDR_int_use:c { none } }
\ExplSyntaxOff

\begin{CDRBlock} [
  tags=none,
  numbers=left,
  firstnumber=last,
]
A
B
C
\end{CDRBlock}
\ExplSyntaxOn
\CDR_typeout:n {none = \CDR_int_use:c { none } }
\ExplSyntaxOff

\begin{CDRBlock} [
  tags=none,
  numbers=left,
  firstnumber=last,
]
A
B
C
\end{CDRBlock}
\ExplSyntaxOn
\CDR_typeout:n {none = \CDR_int_use:c { none }}
\ExplSyntaxOff

\egroup

\subsubsection{\textsf{fancyvrb} multi tags}

\bgroup

\CDRSet{pygments=false}

\begin{CDRBlock} [
  tags={A,B,C},
  numbers=left,
  firstnumber=last,
]
A=*1,B=1,C=1
\end{CDRBlock}

\begin{CDRBlock} [
  tags={B,C},
  numbers=left,
  firstnumber=last,
]
A=2,B=*2,C=2
A=2,B=*3,C=3
\end{CDRBlock}

\begin{CDRBlock} [
  tags=C,
  numbers=left,
  firstnumber=last,
]
A=2,B=4,C=*4
A=2,B=4,C=*5
\end{CDRBlock}

\begin{CDRBlock} [
  tags={C, B},
  numbers=left,
  firstnumber=last,
]
A=2,B=4,C=*6
A=2,B=5,C=*7
A=2,B=6,C=*8
\end{CDRBlock}

\begin{CDRBlock} [
  tags={B, A},
  numbers=left,
  firstnumber=last,
]
A=2,B=*7,C=9
A=3,B=*8,C=9
A=4,B=*9,C=9
\end{CDRBlock}
\begin{CDRBlock} [
  tags={A,C},
  numbers=left,
  firstnumber=last,
]
A=*5,B=10,C=9
A=*6,B=10,C=10
A=*7,B=10,C=11
\end{CDRBlock}

\ExplSyntaxOn
\CDR_int_compare:cNnF { A } = 8 { FAILED \\ }
\CDR_int_compare:cNnF { B } = {10} { FAILED \\ }
\CDR_int_compare:cNnF { C } = {12} { FAILED \\ }
\ExplSyntaxOff

\egroup

\subsubsection{\textsf{fancyvrb} properties}

\bgroup

\begin{CDRBlock} [
  pygments=false,
  tags=none,
  numbers=left,
  firstnumber=last,
]
A
B
C
\end{CDRBlock}

\newpage

\egroup

\subsubsection{Display tags}

\makeatletter
\ExplSyntaxOn

\cs_undefine:N \CDR@Line
\cs_undefine:N \CDR_line:nnn
\cs_undefine:N \CDR_line:nn
\cs_undefine:N \CDR@NumberFormat
\cs_undefine:N \CDR@TagsFormat
\cs_undefine:N \CDR@NumberSep
\cs_undefine:N \CDR_info:n

\cs_new:Npn \CDR@Line {
  \CDR_typeout:n {STEP0}
  \peek_meaning_ignore_spaces:NTF [ { \CDR_line:nnn } { 
    \PackageError { code } { Missing~`['~at~first~\CDR@Line~call }
  }
}
%    \end{MacroCode}
%    \begin{MacroCode}
\CDR_int_new:cn { __start } { 0 }
\CDR_int_new:cn { __step  } { 0 }
%    \end{MacroCode}
% \begin{function}{\CDR_line:nnn}
% \begin{syntax}
% \cs{CDR_line:nnn} \Arg{CDR@Line kv list} \Arg{line number} \Arg{line content}
% \end{syntax}
% This is the very first command called when typesetting.
% Some setup are made for line numbering, in particular the |\CDR_if_visible_at_index:n...|
% family is set here.
% The first line of the |...pyg.tex| files must read |\CDR@Line[last=...]{1}{...}|.
% \end{function}
%    \begin{MacroCode}
\cs_new:Npn \CDR_line:nnn [ #1 ] #2 {
  \keys_set:nn { CDR@Line } { #1 }
  \CDR_int_set:cn { __ } { 0 }
  \CDR_if_number_on:TF {
    \CDR_tag_if_eq:cnTF { firstnumber } { last } {
      \clist_map_inline:Nn \g_CDR_tags_clist {
        \clist_map_break:n {
          \CDR_int_set:cc { __start } { ##1 }
        }
      }
    } {
      \CDR_tag_if_eq:cnTF { firstnumber } { auto } {
        \CDR_int_set:cn { __start } { 1 }
      } {
        \CDR_int_set:cn { __start } { \CDR_tag_get:c { firstnumber } }
      }
    }
%    \end{MacroCode}
% Make |__last| absolute only after defining the |\CDR_if_number_single...| conditionals.
%    \begin{MacroCode}
    \CDR_int_compare:cNnTF { __last } = 1 {
      \tl_set:Nn \l_CDR_tl { \prg_return_true: }
    } {
      \tl_set:Nn \l_CDR_tl { \prg_return_false: }
    }
    \exp_args:NNnV
    \prg_set_conditional:Nnn \CDR_if_number_single:  { p, T, F, TF } \l_CDR_tl
    \CDR_int_add:cn { __last } { \CDR_int:c { __start } - 1 }
    \CDR_int_set:cn { __step } { \CDR_tag_get:c { stepnumber } }
\CDR_typeout:n {CDR_line:nnn:\CDR_int_use:c { __last }, #1/\CDR_int_use:c { __start }/\CDR_int_use:c { __step } }
%    \end{MacroCode}
% \begin{function}[EXP,pTF]{\CDR_if_visible_at_index:n}
% \begin{syntax}
% \cs{CDR_if_visible_at_index:nTF} \Arg{relative line number} \Arg{true code} \Arg{false code}
% \end{syntax}
% The \metatt{relative line number} is the first braced token after |\CDR@Line| in the
% various colored |...pyg.tex| files.
% Execute \metatt{true code} if the \metatt{relative line number} is visible, \metatt{false code} otherwise.
% The \metatt{relative line number} visibility depends on the value relative to first number and the step.
% This is relavant only when line numbering is enabled.
% Some setup are made for line numbering, in particular the |\CDR_if_visible_at_index:n...|.
% family is set here.
% \end{function}
%    \begin{MacroCode}
    \CDR_int_compare:cNnTF { __step } < 2 {
      \tl_set:Nn \l_CDR_tl {
        \CDR_int_compare:cNnTF { __last } < { ##1 + \CDR_int:c { __start } - 1 } {
          \prg_return_false:
        } {
          \prg_return_true:
        }
      }
      \CDR_int_set:cn { __step } { 1 }
    } {
      \tl_set:Nn \l_CDR_tl {
        \bool_if:nTF {
          \int_compare_p:nNn {
            ( ##1 + \CDR_int:c { __start } - 1 )
            / \CDR_int:c { __step }  * \CDR_int:c { __step }
            - \CDR_int:c { __start } + 1
          } = { ##1 }
          && ! \CDR_int_compare_p:cNn { __last } < { ##1 + \CDR_int:c { __start } - 1 }
        } {
          \prg_return_true:
        } {
          \prg_return_false:
        }
      }
    }
    \exp_args:NNnV
    \prg_set_conditional:Nnn \CDR_if_visible_at_index:n { p, T, F, TF } \l_CDR_tl
%    \end{MacroCode}
%    \begin{MacroCode}
    \CDR_int_compare:cNnTF { __step } < 2 {
      \tl_set:Nn \l_CDR_tl {
        \CDR_int_compare:cNnTF { __last } < { ##1 } {
          \prg_return_false:
        } {
          \prg_return_true:
        }
      }
      \CDR_int_set:cn { __step } { 1 }
    } {
      \tl_set:Nn \l_CDR_tl {
        \bool_if:nTF {
          \int_compare_p:nNn {
            ( ##1 ) / \CDR_int:c { __step } * \CDR_int:c { __step }
          } = { ##1 }
          && ! \CDR_int_compare_p:cNn { __last } < { ##1 }
        } {
          \prg_return_true:
        } {
          \prg_return_false:
        }
      }
    }
    \exp_args:NNnV
    \prg_set_conditional:Nnn \CDR_if_number_visible:n { p, T, F, TF } \l_CDR_tl
%    \end{MacroCode}
%    \begin{MacroCode}
    \CDR_int_compare:cNnTF { __start } > {
      \CDR_int:c { __last } / \CDR_int:c { __step } * \CDR_int:c { __step }
    } {
      \tl_set:Nn \l_CDR_tl { \prg_return_true: }
    } {
      \tl_set:Nn \l_CDR_tl { \prg_return_false: }
    }
    \exp_args:NNnV 
    \prg_set_conditional:Nnn \CDR_if_no_number:  { p, T, F, TF } \l_CDR_tl
    \cs_set:Npn \CDR@Line ##1 {
      \CDR_int_set:cn { __ } { ##1 + \CDR_int:c { __start } - #2 }
      \CDR@@Line
    }
    \CDR_int_set:cn { __ } { \CDR_int:c { __start } + 1 - #2 }
  } {
    \cs_set:Npn \CDR@Line ##1 {
      \CDR@@Line
    }
  }
  \CDR_typeout:n {STEP_A, \CDR_int_use:c {__step}, \CDR_int_use:c {__last} }
%    \end{MacroCode}
% \begin{function}{\CDR_if_middle_column:, \CDR_if_right_column:}
% \begin{syntax}
% \cs{CDR_int_if_middle_column:TF} \Arg{true code} \Arg{false code}
% \cs{CDR_int_if_right_column:TF} \Arg{true code} \Arg{false code}
% \end{syntax}
% Execute \metatt{true code} when in the middle or right column,
% \metatt{false code} otherwise.
% \end{function}
%    \begin{MacroCode}
  \prg_set_conditional:Nnn \CDR_if_middle_column: { p, T, F, TF } { \prg_return_false: }
  \prg_set_conditional:Nnn \CDR_if_right_column:  { p, T, F, TF } { \prg_return_false: }
%    \end{MacroCode}
% Convenient method to branch whether one line number will be displayed or not,
% considering the stepping.
% When numbering is on, each code chunk must have at least one number.
% One solution is to allways display the first one but it is not satisfying
% when lines are numbered stepwise, moreover when the tags should be displayed.
%    \begin{MacroCode}
\CDR_typeout:n {STEP_NN_0}
  \tl_clear:N \l_CDR_tl
  \CDR_tags_if_already:TF {
    \tl_put_right:Nn \l_CDR_tl { _N }
  } {
    \str_case:nnF { \CDR_tag_get:c { show~tags } } {
      { left  } { \tl_put_right:Nn \l_CDR_tl { _L } }
      { right } { \tl_put_right:Nn \l_CDR_tl { _R } }
      { none  } { \tl_put_right:Nn \l_CDR_tl { _N } }
      { numbers } { \tl_put_right:Nn \l_CDR_tl { _A } }
      { mirror  } { \tl_put_right:Nn \l_CDR_tl { _M } }
    } { \PackageError
          { coder }
          { Unknown~show~tags~options~:~ \CDR_tag_get:c { show~tags } }
    }
  }
%    \end{MacroCode}
% By default, the next line is displayed with no tag, but the real content may
% change to save space.
%    \begin{MacroCode}
  \exp_args:Nx
  \str_case:nnF { \CDR_tag_get:c { numbers } } {
    { left  } {
      \tl_put_right:Nn \l_CDR_tl { _L }
      \cs_set:Npn \CDR@@Line { \CDR_line_box_N_L:n }
    }
    { right } {
      \tl_put_right:Nn \l_CDR_tl { _R }
      \cs_set:Npn \CDR@@Line { \CDR_line_box_N_R:n }
    }
    { none  } {
      \tl_put_right:Nn \l_CDR_tl { _N }
      \cs_set:Npn \CDR@@Line { \CDR_line_box_N_N:n }    
    }
  } { \PackageError
        { coder }
        { Unknown~numbers~options~:~ \CDR_tag_get:c { numbers } }
  }
\CDR_typeout:n {BRANCH:CDR_line \l_CDR_tl :n}
  \use:c { CDR_line \l_CDR_tl :n }  
}
%    \end{MacroCode}
%
% \begin{function}{\CDR_line_[LRNA]_[LRN]:nn}
% \begin{syntax}
% \cs{CDR_line_[LRNA]_[LRN]:nn} \Arg{line number} \Arg{line content}
% \end{syntax}
% These functions may be called by |\CDR_line:nn| on each block.
% |LRNA| corresponds to the |show tags| options
% whereas |LRN| corresponds to the |numbers| options.
% These functions display the first line and setup the next one.
% \end{function}
%    \begin{MacroCode}
\cs_new:Npn \CDR_line_N_N:n {
\typeout {STEP:CDR_line_N_N:n}
  \CDR_line_box_N_N:n
}
\cs_new:Npn \CDR_line_L_N:n {
\typeout {STEP:CDR_line_L_N:n}
  \CDR_line_box_L_N:n
}
\cs_new:Npn \CDR_line_R_N:n {
\typeout {STEP:CDR_line_R_N:n}
  \CDR_line_box_R_N:n
}

\cs_new:Npn \CDR_line_A_N:n #1 {
\CDR_typeout:n {STEP:CDR_line_A_N:n}
  \CDR_line_box_N_N:n
}

\cs_new:Npn \CDR_line_M_N:n #1 {
\CDR_typeout:n {STEP:CDR_line_M_N:n}
  \CDR_line_box_N_N:n
}

\cs_new:Npn \CDR_line_N_L:n #1 {
\CDR_typeout:n {STEP:CDR_line_N_L:n}
  \CDR_if_no_number:TF {
    \CDR_line_box:nnn {
      \CDR_info_N_L:n { \CDR@NumberMain }
    } { #1 } {}
  } {
    \CDR_line_box_N_L:n
  }
}

\cs_set_eq:NN \CDR_line_L_L:n \CDR_line_N_N:n

\cs_new:Npn \CDR_line_R_L:n #1 {
\CDR_typeout:n {STEP:CDR_line_R_L:n}
  \CDR_line_box:nnn {
    \CDR_if_no_number:TF {
      \CDR_info_N_L:n { \CDR@NumberMain }
    } {
      \CDR_info_N_L:n { \CDR_number_alt: }
    }
  } { #1 } {
    \CDR_info_T_R:n { }
  }
}

\cs_set_eq:NN \CDR_line_A_L:n \CDR_line_L_L:n
\cs_set_eq:NN \CDR_line_M_L:n \CDR_line_R_L:n
\cs_set_eq:NN \CDR_line_N_R:n \CDR_line_N_N:n

\cs_new:Npn \CDR_line_L_R:n #1 {
\CDR_typeout:n {STEP:CDR_line_L_R:n}
  \CDR_line_box:nnn {
    \CDR_info_T_L:n { }
  } { #1 } {
    \CDR_if_no_number:TF {
      \CDR_info_N_R:n { \CDR@NumberMain }
    } {
      \CDR_info_N_R:n { \CDR_number_alt: }
    }
  }
}



\cs_set_eq:NN \CDR_line_R_R:n \CDR_line_N_N:n

\cs_set_eq:NN \CDR_line_A_R:n \CDR_line_R_R:n
\cs_set_eq:NN \CDR_line_M_R:n \CDR_line_L_R:n

\cs_new:Npn \CDR_line_box_N_N:n #1 {
\CDR_typeout:n {STEP:CDR_line_box_N_N:n}
  \CDR_line_box:nnn { } { #1 } {}
}

\cs_new:Npn \CDR_line_box_L_N:n #1 {
\CDR_typeout:n {STEP:CDR_line_box_L_N:n}
  \CDR_line_box:nnn { \CDR_info_N_L:n { } } { #1 } {}
}

\cs_new:Npn \CDR_line_box_R_N:n #1 {
\CDR_typeout:n {STEP:CDR_line_box_R_N:n}
  \CDR_line_box:nnn { \CDR_info_N_R:n { } } { #1 } {}
}

\cs_new:Npn \CDR_line_box_N_L:n #1 {
\CDR_typeout:n {STEP:CDR_line_box_N_L:n}
  \CDR_line_box:nnn {
    \CDR_info_N_L:n { \CDR_number_alt:n { \CDR_int_use:c { __ } } }
  } { #1 } {}
}

\cs_set_eq:NN \CDR_line_box_L_L:n \CDR_line_box_N_N:n
\cs_set_eq:NN \CDR_line_box_R_L:n \CDR_line_box_N_N:n
\cs_set_eq:NN \CDR_line_box_A_L:n \CDR_line_box_L_L:n
\cs_set_eq:NN \CDR_line_box_M_L:n \CDR_line_box_R_L:n

\cs_set_eq:NN \CDR_line_box_N_R:n \CDR_line_box_N_N:n
\cs_set_eq:NN \CDR_line_box_L_R:n \CDR_line_box_N_N:n
\cs_set_eq:NN \CDR_line_box_R_R:n \CDR_line_box_N_N:n

\cs_set_eq:NN \CDR_line_box_A_R:n \CDR_line_box_R_R:n
\cs_set_eq:NN \CDR_line_box_M_R:n \CDR_line_box_L_R:n
%    \end{MacroCode}
%
% \begin{function}{\CDR_line_box:nnn, \CDR_line_box_L:nn, \CDR_line_box_R:nn, \CDR_line_box:nn}
% \begin{syntax}
% \cs{CDR_line_box:nnn} \Arg{left info} \Arg{line content} \Arg{right info}
% \cs{CDR_line_box_L:nn} \Arg{left info} \Arg{line content}
% \cs{CDR_line_box_R:nn} \Arg{right info} \Arg{line content}
% \end{syntax}
% Returns an hbox with the given material.
% The first |LR| command is the reference, from which are derived the |L|, |R| and |N| commands.
% At run time the |\CDR_line_box:nn| is defined to call one of the above commands
% (with the same signarture).
% \end{function}
%    \begin{MacroCode}
\cs_new:Npn \CDR_line_box:nnn #1 #2 #3 {
\CDR_typeout:n {STEP:CDR_line_box_LR:nn/}
\CDR_typeout:n {STEP:CDR_line_box_LR:nn/\tl_to_str:n{#1}/}
\CDR_typeout:n {STEP:CDR_line_box_LR:nn/\tl_to_str:n{#2}/}
\CDR_typeout:n {STEP:CDR_line_box_LR:nn/\tl_to_str:n{#3}/}
  \hbox to \hsize {
    \kern \leftmargin
    #1
    \hbox to \linewidth {
      \FV@LeftListFrame
      #2
      \hss
      \FV@RightListFrame
    }
    #3
  }
}
\cs_new:Npn \CDR_line_box_L:nn #1 #2 {
  \CDR_line_box:nnn { #1 } { #2 } {}
}
\cs_new:Npn \CDR_line_box_R:nn #1 #2 {
\CDR_typeout:n {STEP:CDR_line_box_R:nn}
  \CDR_line_box:nnn { } {#2} { #1 }
}
\cs_new:Npn \CDR_line_box_N_N:nn #1 #2 {
\CDR_typeout:n {STEP:CDR_line_box_N_N:nn}
  \CDR_line_box:nnn { } { #2 } {}
}
%    \end{MacroCode}
%
% \begin{function}{\CDR_line_box:NNn}
% \begin{syntax}
% \cs{CDR_line_box:NNnn} \meta{line boxer} \meta{info builder} \Arg{line number} \Arg{line content}
% \end{syntax}
% \end{function}
%    \begin{MacroCode}[OK]
\cs_new:Npn \CDR_line_build_N:nn {
\CDR_typeout:n {STEP:CDR_line_build_N:nn}
   \CDR_line_box_N_N:nn
}
%    \end{MacroCode}
%    \begin{MacroCode}
\cs_new:Npn \CDR_line_build_L:nn #1 {
  \CDR_if_number_single:TF {
    \CDR_line_box_L:nn { \CDR_info_N_L:n { \CDRNumberMain{ #1 } } }
  } {
    \CDR_if_no_number:TF {
      \cs_set:Npn \CDR@@Line ##1 {
        \CDR_line_box_L:nn { \CDR_info_N_L:n { \CDRNumberOther{ ##1 } } }
      }
      \CDR_line_box_L:nn { \CDR_info_N_L:n { \CDRNumberMain{ #1 } } }
    } {
      \cs_set:Npn \CDR@@Line ##1 {
        \CDR_line_box_L:nn { \CDR_info_N_L:n { \CDR_number_alt:n { ##1 } } }
      }
      \CDR@Line { #1 }
    }
  }
}
\cs_new:Npn \CDR_line_build_L_T:nn #1 {
\CDR_typeout:n {CDR_line_build_L_T:nn\space\CDR_if_number_single:TF TF}
  \CDR_if_number_single:TF {
    \CDR_line_box_L:nn { \CDR_info_T_L:n { \space\CDRNumberMain{ #1 } } }
  } {
    \CDR_if_no_number:TF {
      \cs_set:Npn \CDR@@Line ##1 {
        \cs_set:Npn \CDR@@Line ####1 {
          \CDR_line_box_L:nn { \CDR_info_N_L:n { \CDRNumberOther{ ####1 } } }
        }
        \CDR_line_box_L:nn { \CDR_info_N_L:n { \CDRNumberMain{ ##1 } } }
      }
    } {
      \CDR_if_visible_at_index:nTF { 2 } {
        \cs_set:Npn \CDR@@Line ##1 {
          \CDR_line_box_L:nn { \CDR_info_N_L:n { \CDR_number_alt:n { ##1 } } }
        }
      } {
        \CDR_if_visible_at_index:nTF { 3 } {
          \cs_set:Npn \CDR@@Line ##1 {
            \CDR_line_box_L:nn { \CDR_info_N_L:n { \CDR_number_alt:n { ##1 } } }
          }
        } {
          \cs_set:Npn \CDR@@Line ##1 {
            \cs_set:Npn \CDR@@Line ####1 {
              \CDR_line_box_L:nn { \CDR_info_N_L:n { \CDR_number_alt:n { ####1 } } }
            }
            \CDR_line_box_L:nn { \CDR_info_T_L:n { \CDRNumberMain{ ##1 } } }
          }
        }
      }
    }
    \CDR_line_box_L:nn { \CDR_info_T_L:n { } }
  }
}
%    \end{MacroCode}
%    \begin{MacroCode}
\cs_new:Npn \CDR_line_build_R_T:nn #1 {
\CDR_typeout:n {CDR_line_build_R_T:nn\space\CDR_if_number_single:TF TF}
  \CDR_if_number_single:TF {
    \CDR_line_box_R:nn { \CDR_info_T_R:n { \space\CDRNumberMain{ #1 } } }
  } {
    \CDR_if_no_number:TF {
      \cs_set:Npn \CDR@@Line ##1 {
        \cs_set:Npn \CDR@@Line ####1 {
          \CDR_line_box_R:nn { \CDR_info_N_R:n { \CDRNumberOther{ ####1 } } }
        }
        \CDR_line_box_R:nn { \CDR_info_N_R:n { \CDRNumberMain{ ##1 } } }
      }
    } {
      \CDR_if_visible_at_index:nTF { 2 } {
        \cs_set:Npn \CDR@@Line ##1 {
          \CDR_line_box_R:nn { \CDR_info_N_R:n { \CDR_number_alt:n { ##1 } } }
        }
      } {
        \CDR_if_visible_at_index:nTF { 3 } {
          \cs_set:Npn \CDR@@Line ##1 {
            \CDR_line_box_R:nn { \CDR_info_N_R:n { \CDR_number_alt:n { ##1 } } }
          }
        } {
          \cs_set:Npn \CDR@@Line ##1 {
            \cs_set:Npn \CDR@@Line ####1 {
              \CDR_line_box_R:nn { \CDR_info_N_R:n { \CDR_number_alt:n { ####1 } } }
            }
            \CDR_line_box_R:nn { \CDR_info_T_R:n { \CDRNumberMain{ ##1 } } }
          }
        }
      }
    }
    \CDR_line_box_L:nn { \CDR_info_T_R:n { } }
  }
}
%    \end{MacroCode}
%    \begin{MacroCode}
\cs_new:Npn \CDR_line_build_R:nn #1 {
  \CDR_if_number_single:TF {
    \CDR_line_box_R:nn { \CDR_info_N_R:n { \CDRNumberMain{ #1 } } }
  } {
    \CDR_if_no_number:TF {
      \cs_set:Npn \CDR@@Line ##1 {
        \CDR_line_box_R:nn { \CDR_info_N_R:n { \CDRNumberOther{ ##1 } } }
      }
      \CDR_line_box_R:nn { \CDR_info_N_R:n { \CDRNumberMain{ #1 } } }
    } {
      \cs_set:Npn \CDR@@Line ##1 {
        \CDR_line_box_R:nn { \CDR_info_N_R:n { \CDR_number_alt:n { ##1 } } }
      }
      \CDR@Line { #1 }
    }
  }
}
%    \end{MacroCode}
%
% \begin{function}{\CDR_line:nn}
% \begin{syntax}
% \cs{CDR_line:nn} \Arg{line number} \Arg{line content}
% \end{syntax}
% This is a one shot function called at the top of each code block.
% \end{function}
%    \begin{MacroCode}
\cs_new:Npn \CDR_line:n {
%  \exp_args:Nf
%  \str_case:nnF { \CDR_tag_get:c { numbers } } {
%    { left } {
%\CDR_typeout:n {STEP_NN_left}
%      \bool_if:nTF {
%        \CDR_tags_if_visible_p:n { left } || \CDR_tags_if_visible_p:n { numbers }
%      } {
%        \cs_set:Npn \CDR@@Line { \CDR_line_build_L_T:nn }
%      } {
%        \CDR_tags_if_visible:nTF { right } {
%          \cs_set:Npn \CDR@@Line { \CDR_line_build_L_T:nn }
%        } {
%          \cs_set:Npn \CDR@@Line { \CDR_line_build_L:nn }
%        }
%      }
%    }
%    { right } {
%\CDR_typeout:n {STEP_NN_right}
%      \bool_if:nTF {
%        \CDR_tags_if_visible_p:n { right } || \CDR_tags_if_visible_p:n { numbers }
%      } {
%        \cs_set:Npn \CDR@@Line { \CDR_line_build_R_T:nn }
%      } {
%        \cs_set:Npn \CDR@@Line { \CDR_line_build_R:nn }
%      }
%    }
%    { none } {
%\CDR_typeout:n {STEP_NN_none}
%      \CDR_tags_if_visible:nTF { left } {
%\CDR_typeout:n {STEP_NN_none_left}
%        \cs_set:Npn \CDR@@Line ##1 {
%          \cs_set:Npn \CDR@@Line { \CDR_line_build_N:nn }
%          \CDR_line_box_L:nn { \CDR_info_T_L:n { } }
%        }
%      } {
%        \CDR_tags_if_visible:nTF { right } {
%\CDR_typeout:n {STEP_NN_none_right}
%          \cs_set:Npn \CDR@@Line ##1 {
%            \cs_set:Npn \CDR@@Line { \CDR_line_build_N:nn }
%            \CDR_line_box_L:nn { \CDR_info_T_R:n { } }
%          }
%        } {
%\CDR_typeout:n {STEP_NN_none_none}
%          \cs_set:Npn \CDR@@Line { \CDR_line_build_N:nn }
%        }
%      }
%    }
%  } { \PackageError { coder } { Unknown~numbers~options~:~ \CDR_tag_get:c { numbers }} }
%\CDR_typeout:n {STEP_NN_1}
%  \CDR@Line
}
%    \end{MacroCode}
%
% \begin{function}{\CDR_line:nn}
% \begin{syntax}
% \cs{CDR_line:nn} \Arg{line number} \Arg{line content}
% \end{syntax}
% Execute \metatt{true code} if the \metatt{linenumber} is visible, \metatt{false code} otherwise.
% The \metatt{linenumber} visibility depends on the value relative to first number and the step.
% This is relavant only when line numbering is enabled.
% Some setup are made for line numbering, in particular the |\CDR_if_visible_at_index...|
% and |\CDR_if_number_visible...| conditionals are set here.
% \end{function}
%    \begin{MacroCode}
%    \end{MacroCode}
%
% \begin{function}{\CDR_info_N_L:n, \CDR_info_N_R:n,\CDR_info_T_L:n, \CDR_info_T_R:n}
% \begin{syntax}
% \cs{CDR_info_N_L:n} \Arg{line number}
% \cs{CDR_info_T_L:n} \Arg{line number}
% \end{syntax}
% Core methods to display the left and right information. The |T| variants contain
% tags informations, they are only used on the first line eventually.
% The |N| variants are for line numbers only.
% \end{function}
%    \begin{MacroCode}
\cs_new:Npn \CDR_info_N_L:n #1 {
  \hbox_overlap_left:n {
    \cs_set:Npn \baselinestretch { 1 }
    { \CDR@NumberFormat
      #1
    }
    \CDR@NumberSep
  }
}
\cs_new:Npn \CDR_info_T_L:n #1 {
  \hbox_overlap_left:n {
    \cs_set:Npn \baselinestretch { 1 }
    \CDR@NumberFormat
    \smash{
    \parbox[b]{\marginparwidth}{
      \raggedleft
        { \CDR@TagsFormat \g_CDR_tags_clist :} 
      }
      #1
    }
    \CDR@NumberSep
  }
}
\cs_new:Npn \CDR_info_N_R:n #1 {
  \hbox_overlap_right:n {
    \CDR@NumberSep
    \cs_set:Npn \baselinestretch { 1 }
    \CDR@NumberFormat
    #1
  }
}
\cs_new:Npn \CDR_info_T_R:n #1 {
  \hbox_overlap_left:n {
    \cs_set:Npn \baselinestretch { 1 }
    \CDR@NumberSep
    \CDR@NumberFormat
    \smash {
      \parbox[b]{\marginparwidth}{
        \raggedright
        #1:
        { \CDR@TagsFormat \g_CDR_tags_clist} 
      }
    }
  }
}
%    \end{MacroCode}
%    \begin{MacroCode}

\cs_new:Npn \CDR@NumberFormat {
  \CDR_tag_get:c { numbers~format }
}
\cs_new:Npn \CDR@TagsFormat {
  \CDR_tag_get:c { tags~format }
}
\cs_new:Npn \CDR@NumberSep {
  \hspace{ \CDR_tag_get:c { numbersep } }
}

%\cs_set:Npn \CDR_info_body:n { \use_none:n }

%    \end{MacroCode}
% \begin{function}{\CDR_info_body_core:n}
% First line.
% \end{function}
%    \begin{MacroCode}
%    \end{MacroCode}
% \begin{function}{\CDR_number_alt:n}
% First line.
% \end{function}
%    \begin{MacroCode}
\cs_set:Npn \CDR_number_alt:n #1 {
  \use:c { CDR@Number 
    \CDR_if_number_visible:nTF { #1 } { Main } { Other }
  } { #1 }
}

%    \end{MacroCode}
%
% \begin{function}{\CDRNumberMain, \CDRNumberOther}
% \begin{syntax}
% \cs{CDRNumberMain}  \Arg{integer expression}
% \cs{CDRNumberOther} \Arg{integer expression}
% \end{syntax}
% This is used when typesseting line numbers.
% The default |...Other| function just gobble one argument.
% The \metatt{integer expression} is exactly what will be displayed.
% \end{function}
%    \begin{MacroCode}
\cs_new:Npn \CDRNumberMain {
		\use:n
}
\cs_new:Npn \CDRNumberOther {
		\use_none:n
}
%    \end{MacroCode}
%
% \begin{function}{\CDR@NumberMain, \CDR@NumberOther}
% \begin{syntax}
% \cs{CDR@NumberMain}
% \cs{CDR@NumberOther}
% \end{syntax}
% Respectively apply |\CDR@NumberMain| or |\CDR@NumberOther|
% on |\CDR_int_get:c { __ }|
% \end{function}
%    \begin{MacroCode}
\cs_new:Npn \CDR@NumberMain {
		\CDR@NumberMain { \CDR_int_get:c { __ } }
}
\cs_new:Npn \CDR@NumberOther {
		\CDR@NumberOther { \CDR_int_get:c { __ } }
}
%    \end{MacroCode}
%
% \begin{function}{\CDR_info_body_tags:NN}
% \begin{syntax}
% \cs{CDR_info_body_tags:NN} \meta{info command:n} \meta{tags formatter:nn}
% \end{syntax}
% This is called exactly once for very first line of each pygmented source.
% \end{function}
%    \begin{MacroCode}
%    \end{MacroCode}
% \begin{function}{\CDR_info_body_tags:N}
% \begin{syntax}
% \cs{CDR_info_body_tags:N} \meta{info command:n}
% \end{syntax}
% This is called exactly once for very first line of each pygmented source.
% \end{function}
%    \begin{MacroCode}
%    \end{MacroCode}
% \begin{function}{\CDR_info_body_a:n}
% \begin{syntax}
% \cs{CDR_info_L_body:n} \Arg{line number}
% \end{syntax}
% First line.
% \end{function}
% Display the line number unless the step is >0 and the next line number is displayed.
%    \begin{MacroCode}

\ExplSyntaxOff
\makeatother

\bgroup

tests start here:

%\begin{CDRBlock}[
%  tags={we are the champions,  whatever it isp},
%  fontfamily=menlo,
%  fontsize=\large,
%  pygments=true,
%  lang=lua,
%  numbers=left,
%  debug=true,
%  show tags
%]
%function foo(arg) return arg ** arg end -- tags expected
%\end{CDRBlock}

\ExplSyntaxOn
PYGMENTS: \CDR_tag_get:cc { __pygments } { pygments } \\
\ExplSyntaxOff
\CDRSet{
  tags={NONE,ENON},
  pygments=true,
  lang=lua,
  numbers=right,
  debug=true,
  show tags = none,
  firstnumber = 33,
}
\ExplSyntaxOn
PYGMENTS: \CDR_tag_get:cc { __pygments } { pygments } \\
TAGS: \CDR_tag_get:cc { default.block } { tags } \\
TAGS: \g_CDR_tags_clist \\
\ExplSyntaxOff
\begin{CDRBlock}[
  stepnumber=1,
]
function foo(arg) return 0 end
\end{CDRBlock}
\ExplSyntaxOn
NONE: \CDR_int_use:c { NONE } \\
ENON: \CDR_int_use:c { ENON } \\
\ExplSyntaxOff

\begin{CDRBlock}[
  stepnumber=1,
  firstnumber = last,
]
function foo(arg) -- no tags expected
  2
  3
  4
  5
  6
end
\end{CDRBlock}

\ExplSyntaxOn
NONE: \CDR_int_use:c { NONE } \\
ENON: \CDR_int_use:c { ENON } \\
\ExplSyntaxOff

\begin{CDRBlock}[
  stepnumber=1,
  firstnumber = auto,
]
function foo(arg) -- no tags expected
  2
  3
  4
  5
  6
end
\end{CDRBlock}
\ExplSyntaxOn
NONE: \CDR_int_use:c { NONE } \\
ENON: \CDR_int_use:c { ENON } \\
\ExplSyntaxOff

\begin{CDRBlock}[
%  tags={we are the champions,  whatever it isp},
  pygments,
  lang=lua,
  numbers=none,
  debug,
  show tags=none,
  only top=false,
]
function foo(arg) -- no tags expected
  -- second line
  -- third line
  -- fourth line
  -- fifth line
  return arg ** arg
end
\end{CDRBlock}


\begin{CDRBlock}[
%  tags={we are the champions,  whatever it isp},
  fontfamily=menlo,
  fontsize=\large,
  pygments=true,
  lang=lua,
  numbers=left,
  debug=true,
  show tags,
  only top=false
]
function foo(arg) return arg ** arg end -- tags expected
\end{CDRBlock}
\begin{CDRBlock}[
  tags={whatever it isp,we are the champions},
  fontfamily=menlo,
  fontsize=\large,
  pygments=true,
  lang=lua,
  numbers=left,
  debug=true,
  show tags,
  only top
]
function foo(arg) return arg ** arg end -- tags expected
\end{CDRBlock}
\begin{CDRBlock}[
%  tags={we are the champions,  whatever it isp},
  pygments,
  lang=lua,
  numbers=none,
  debug,
  showspaces,
  show tags=none,
  only top=false,
]
function foo(arg) -- no tags expected
  -- second line
  -- third line
  -- fourth line
  -- fifth line
  return arg ** arg
end
\end{CDRBlock}

\egroup

\subsubsection{Exhaustive test}

\bgroup

\CDRSet {
  pygments,
  lang=lua,
}
\begin{CDRBlock}[
        show tags=none,
        numbers=none,
        stepnumber=1
]
function foo(arg) return arg ** arg end
\end{CDRBlock}
%\egroup
%\egroup
%\endinput
\makeatletter
\def\CDR@nnn#1#2#3{
  \CDRSet {
    show tags=#1,
    numbers=#2,
    stepnumber=#3
  }
  \bgroup
  \input{./Tests/test_single.tex}
  \input{./Tests/test_more.tex}
  \egroup
}
\CDR@nnn{none}{none}{0}
\CDR@nnn{none}{none}{1}
\CDR@nnn{none}{none}{5}
\CDR@nnn{none}{left}{0}
\CDR@nnn{none}{left}{1}
\CDR@nnn{none}{left}{5}
\CDR@nnn{none}{right}{0}
\CDR@nnn{none}{right}{1}
\CDR@nnn{none}{right}{5}
\CDR@nnn{left}{none}{0}
\CDR@nnn{left}{none}{1}
\CDR@nnn{left}{none}{5}
\CDR@nnn{left}{left}{0}
\CDR@nnn{left}{left}{1}
\CDR@nnn{left}{left}{5}
\CDR@nnn{left}{right}{0}
\CDR@nnn{left}{right}{1}
\CDR@nnn{left}{right}{5}
\CDR@nnn{right}{none}{0}
\CDR@nnn{right}{none}{1}
\CDR@nnn{right}{none}{5}
\CDR@nnn{right}{left}{0}
\CDR@nnn{right}{left}{1}
\CDR@nnn{right}{left}{5}
\CDR@nnn{right}{right}{0}
\CDR@nnn{right}{right}{1}
\CDR@nnn{right}{right}{5}
\CDR@nnn{numbers}{none}{0}
\CDR@nnn{numbers}{none}{1}
\CDR@nnn{numbers}{none}{5}
\CDR@nnn{numbers}{left}{0}
\CDR@nnn{numbers}{left}{1}
\CDR@nnn{numbers}{left}{5}
\CDR@nnn{numbers}{right}{0}
\CDR@nnn{numbers}{right}{1}
\CDR@nnn{numbers}{right}{5}
\CDR@nnn{mirror}{none}{0}
\CDR@nnn{mirror}{none}{1}
\CDR@nnn{mirror}{none}{5}
\CDR@nnn{mirror}{left}{0}
\CDR@nnn{mirror}{left}{1}
\CDR@nnn{mirror}{left}{5}
\CDR@nnn{mirror}{right}{0}
\CDR@nnn{mirror}{right}{1}
\CDR@nnn{mirror}{right}{5}
%
% BUGGY
%\ExplSyntaxOn
%\clist_map_inline:nn { none, left, right, auto } {
%  \clist_map_inline:nn { none, left, right } {
%    \clist_map_inline:nn { 0, 1, 5 } {
%\CDR_typeout:n {===== SHOW_TAGS=#1}
%\CDR_typeout:n {===== NUMBERS=##1}
%\CDR_typeout:n {===== STEPNUMBER=####1}
%      \bgroup
%        \CDR@nnn { #1 } { ##1 } { ####1 }
%      \egroup
%    }
%  }
%}
%\ExplSyntaxOff
%\makeatother
%\egroup


\egroup
