% !TeX program=lualatex
% !TeX root=../coder_test.tex
\noindent
\makeatletter

\def\CDR@Debug { \typeout }
\ExplSyntaxOn

\bgroup

\cs_set:Npn \CDR_block_preflight:n #1 {
  \clist_if_empty:nF { #1 } {
    \par\noindent Block~options:
    \begin{itemize}
    \ttfamily
    \clist_map_inline:nn { #1 } {
      \item \tl_to_str:n { ##1 }
    }
    \end{itemize}
  }
}
\cs_set:Npn \CDR_set_preflight:n #1 {
  \clist_if_empty:nF { #1 } {
    \par\noindent CDRSet:
    \begin{itemize}
    \ttfamily
    \clist_map_inline:nn { #1 } {
      \item \tl_to_str:n { ##1 }
    }
    \end{itemize}
  }
}

\cs_set:Npn \FVB@CDRBlock {
\typeout{DEBUG==============================================}
\typeout{\FV@KeyValues}
  \@bsphack
  \group_begin:
  \exp_args:NV \CDR_block_preflight:n \FV@KeyValues
%    \end{MacroCode}
% Set the |\CDR_if_block[_p]:...| conditional family.
%    \begin{MacroCode}
  \prg_set_conditional:Nnn \CDR_if_block: { p, T, F, TF } {
    \prg_return_true:
  }  
%    \end{MacroCode}
% Reading the options: we absorb the options available in |\FV@KeyValues|,
% first for \pkg{l3keys} modules, except for line numbering because
% management is different whether \pkg{pygments} is used or not.
%    \begin{MacroCode}
  \CDR_tag_keys_set:nn { __block } { __initialize }
  \CDR_keys_inherit:Vnn \c_CDR_tag { __local } {
    __block, __pygments.block, default.block, __fancyvrb.block,
    __pygments, default, __fancyvrb,  __fancyvrb.number
  }
  \CDR_tag_keys_set_known:nVN { __local } \FV@KeyValues \l_CDR_kv_clist
\typeout{DEBUG_STEP_2}
\typeout{\l_CDR_kv_clist}
  \CDR_tag_provide_from_kv:V \l_CDR_kv_clist
  \CDR_tag_keys_set_known:nVN { __local } \l_CDR_kv_clist \l_CDR_kv_clist
\CDR@Debug{CDRBlock.KV1:\l_CDR_kv_clist}
%    \end{MacroCode}
% This is done by |\CDR_block_setup_tags:|. Once the list of tags is established,
% \CDRLua{} is setup accordingly.
%    \begin{MacroCode}
  \CDR_block_setup_tags:
  \lua_now:n {
    CDR:hilight_block_setup('g_CDR_tags_clist')
  }
  \clist_map_inline:Nn \c_CDRBlock@FV_clist {
    \typeout { KV: ##1, \CDR_tag_get:c { ##1 } }
  }
  \typeout { FRAME=\CDR_tag_get:cc { __fancyvrb.block } { frame } }

%    \end{MacroCode}
% |\l_CDR_pyg_bool| is |true| iff one of the tags needs \pkg{pygments} or there is no tag and |pygments=true| was given.
%    \begin{MacroCode}
  \CDR_set_conditional:Nnnn \CDR_if_pygments:
    { \CDR_tag_if_truthy_p:c { pygments } }
    { \prg_return_true:  }
    { \prg_return_false: }
  \CDR_set_conditional:Nnnn \CDR_if_no_export:
    { \CDR_tag_if_truthy_p:c { no~export } }
    { \prg_return_true:  }
    { \prg_return_false: }
%    \end{MacroCode}
% \begin{function}[EXP,pTF]{\CDR_if_number_on:}
% \begin{syntax}
% \cs{CDR_if_number:TF} \Arg{true code} \Arg{false code}
% \end{syntax}
% Execute \metatt{true code} if line numbering is on,
% \metatt{false code} otherwise.
% \end{function}
%    \begin{MacroCode}
  \CDR_set_conditional:Nnnn \CDR_if_number_on:
    { \CDR_tag_if_eq_p:cn { numbers } { none } }
    { \prg_return_false: }
    { \prg_return_true: }
%    \end{MacroCode}
% \begin{function}[EXP,pTF]{\CDR_tags_if_already:}
% \begin{syntax}
% \cs{CDR_tags_if_already:TF} \Arg{true code} \Arg{false code}
% \end{syntax}
% Execute \meta{true code} when the tags were already displayed or unnecessary,
% \meta{false code} otherwise.
% \end{function}
%    \begin{MacroCode}
  \CDR_set_conditional:Nnnn \CDR_tags_if_already: {
    \CDR_tag_if_truthy_p:c { only~top } &&
    \CDR_clist_if_eq_p:NN \g_CDR_tags_clist \g_CDR_last_tags_clist
  } { \prg_return_true:  }
    { \prg_return_false: }
%    \end{MacroCode}
% And we can setup the engine,
%    \begin{MacroCode}
  \CDR_block_engine_begin:
%    \end{MacroCode}
% That end the common part, we now branch according to \pkg{pygments} used.
%    \begin{MacroCode}
  \CDR_if_pygments:TF {
    \CDRBlock@Pyg
  } {
    \CDRBlock@FV
  }
  \FV@Scan
}


\ExplSyntaxOff


%  \CDRSet {
%    numbers=left,
%    pygments=false,
%  }
%  \input{./Tests/test_single.tex}
%  \vspace{0.5\baselineskip}



%\def \CDR@Debug { \typeout }

\ExplSyntaxOff



\bgroup

%
ESSAI
\begin{Verbatim}
[]
ESSAI
\end{Verbatim}

\makeatletter
\def\FVB@MyVerbatim{
\FV@VerbatimBegin\FV@Scan
}
\def\FVE@MyVerbatim{
\FV@VerbatimEnd
}
\makeatother
\DefineVerbatimEnvironment{MyVerbatim}{MyVerbatim}{}


\begin{MyVerbatim}[fontsize=\Large]
ESSAI
\end{MyVerbatim}


\ExplSyntaxOn
\makeatletter

\cs_new:Npn \CDR_hilight_record:n #1 {
}


\newenvironment { CDRBlock@FVX } {
\CDR@Debug {DEBUG.Block.FV}
%    \end{MacroCode}
% We record the key value options about numbering twice, one for \pkg{fancyvrb}
% and one for \CDRSty{}.
%    \begin{MacroCode}
  \CDR_if_no_export:F {
    \clist_map_inline:nn { i, ii, iii, iv } {
      \cs_set:cpn { FV@ListProcessLine@ ##1 } ####1 {
        \tl_set:Nn \l_CDR_tl { ####1 }
        \lua_now:n { CDR:record_line('l_CDR_tl') }
        \use:c { CDR@ListProcessLine@ ##1 } { ####1 }
      }
    }
  }
%    \end{MacroCode}
% Prepare the counters. The |__| int starts with 0, which means that it is unused.
% If the |firstnumber| value is ``last'' then it is used to store the first number.
%    \begin{MacroCode}
  \CDR_int_set:cn { __ } { 0 }
\CDR@Debug {NUMBERING...}
  \CDR_if_number_on:T {
\CDR@Debug {...ON}
    \CDR_tag_if_eq:cnT { firstnumber } { last } {
      \clist_map_inline:Nn \g_CDR_tags_clist {
        \clist_map_break:n {
          \CDR_int_set:cc { __ } { ##1 }
          \CDR_tag_set:cn { firstnumber } { \CDR_int_use:c { ##1 } }
        }
      }
    }
  }
  \cs_set:Npn \CDR:nn ##1 ##2 {
\CDR@Debug{Debug.CDRBlock.FV.KEYS:\tl_to_str:n{##1}->\tl_to_str:n{##2}}  
    \fvset{ ##1 = { ##2 }, }
  }
  \clist_map_inline:Nn \c_CDRBlock@FV_clist {
    \exp_args:Nnx
    \CDR:nn { ##1 } { \CDR_tag_get:c { ##1 } }
  }
  \CDR_tag_get:c { format }
  \FV@VerbatimBegin
} {
  \FV@VerbatimEnd
  \CDR_if_number_on:T {
    \CDR_int_compare:cNnTF { __ } > 0 {
      \CDR_int_set:cn { __ } {
        \value{FancyVerbLine} - \CDR_int_use:c { __ } + 1
      }
      \clist_map_inline:Nn \g_CDR_tags_clist {
        \CDR_int_gadd:cc { ##1 } { __ }
      }
    } {
      \CDR_int_set:cn { __ } { \value{FancyVerbLine} + 1 }
      \clist_map_inline:Nn \g_CDR_tags_clist {
        \CDR_int_gset:cc { ##1 } { __ }
\CDR@Debug { DEBUG.CDRBlock.FV.Last: ##1/\CDR_int_use:c { ##1 } }
      }
    }
  }
}


\def\CDR@Debug { \typeout }
\makeatother
\ExplSyntaxOff

\begin{luacode}

function CDR:cache_clean_unused()
end

local function cache_record(self, pyg_sty_p, pyg_tex_p)
  if pyg_sty_p then
    self['.style_set']  [pyg_sty_p] = true
  end
  if pyg_tex_p then
    self['.colored_set'][pyg_tex_p] = true
  end
end
local function cache_clean_unused(self)
  local to_remove = {}
  for f in lfs.dir(dir_p) do
    f = dir_p .. f
    if not self['.style_set'][f] and not self['.colored_set'][f] then
      to_remove[f] = true
    end
  end
  for f,_ in pairs(to_remove) do
    os.remove(f)
  end
end

\end{luacode}


%
\begin{CDRBlock}[%
  tags=,
  fontfamily=menlo,
  fontsize=\Large,
  pygments=false,
  lang=lua,
  numbers=left,
  frame=lines,
  format=\color{green},
  debug=true,
  showspaces
]
local f = function(arg)
  return arg ** arg
end
\end{CDRBlock}

\endinput




\typeout {IN PROGRESSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS}
Next should not be void
\CDRSet{cache=false}
\begin{CDRBlock}[
  tags=,
  fontfamily=menlo,
  fontsize=\large,
  pygments=true,
  lang=python,
  numbers=left,
  frame=single,
  debug=true,
]
def foo(arg):
  return arg ** arg
\end{CDRBlock}

Next should not be void
\CDRSet{cache=false}
\begin{CDRBlock}[
  tags=,
  fontfamily=menlo,
  fontsize=\large,
  pygments=true,
  lang=lua,
  numbers=left,
  frame=lines,
  debug=true,
  frame=single,
  framerule=1mm,
  framesep=3mm,
  rulecolor=\color{red},
  fillcolor=\color{yellow},
  showspaces,
  baselinestretch=1.75
]
function foo(arg)
  return arg ** arg
end
\end{CDRBlock}

\egroup

\subsection{Line numbering}

\bgroup


\subsubsection{\textsf{fancyvrb} linear}

\bgroup

\CDRSet{pygments=false}

\begin{Verbatim} [
  numbers=none,
]
A
\end{Verbatim}

\begin{CDRBlock} [
  tags=none,
  numbers=none,
]
A
\end{CDRBlock}

\ExplSyntaxOn
\CDR_int_if_exist:cT { none } { \typeout { none ? FAILURE } }
\ExplSyntaxOff

\begin{CDRBlock} [
  tags=none,
  numbers=left,
  firstnumber=last,
]
A
B
C
\end{CDRBlock}
\ExplSyntaxOn
\typeout {tags = \g_CDR_tags_clist }
\CDR_int_if_exist:cF { none } { \typeout { none ? FAILURE } }
\typeout {none = \CDR_int_use:c { none } }
\ExplSyntaxOff

\begin{CDRBlock} [
  tags=none,
  numbers=left,
  firstnumber=last,
]
A
B
C
\end{CDRBlock}
\ExplSyntaxOn
\typeout {none = \CDR_int_use:c { none } }
\ExplSyntaxOff

\begin{CDRBlock} [
  tags=none,
  numbers=left,
  firstnumber=last,
]
A
B
C
\end{CDRBlock}
\ExplSyntaxOn
\typeout {none = \CDR_int_use:c { none }}
\ExplSyntaxOff

\egroup

\subsubsection{\textsf{fancyvrb} multi tags}

\bgroup

\CDRSet{pygments=false}

\begin{CDRBlock} [
  tags={A,B,C},
  numbers=left,
  firstnumber=last,
]
A=*1,B=1,C=1
\end{CDRBlock}

\begin{CDRBlock} [
  tags={B,C},
  numbers=left,
  firstnumber=last,
]
A=2,B=*2,C=2
A=2,B=*3,C=3
\end{CDRBlock}

\begin{CDRBlock} [
  tags=C,
  numbers=left,
  firstnumber=last,
]
A=2,B=4,C=*4
A=2,B=4,C=*5
\end{CDRBlock}

\begin{CDRBlock} [
  tags={C, B},
  numbers=left,
  firstnumber=last,
]
A=2,B=4,C=*6
A=2,B=5,C=*7
A=2,B=6,C=*8
\end{CDRBlock}

\begin{CDRBlock} [
  tags={B, A},
  numbers=left,
  firstnumber=last,
]
A=2,B=*7,C=9
A=3,B=*8,C=9
A=4,B=*9,C=9
\end{CDRBlock}
\begin{CDRBlock} [
  tags={A,C},
  numbers=left,
  firstnumber=last,
]
A=*5,B=10,C=9
A=*6,B=10,C=10
A=*7,B=10,C=11
\end{CDRBlock}

\ExplSyntaxOn
\CDR_int_compare:cNnF { A } = 8 { FAILED \\ }
\CDR_int_compare:cNnF { B } = {10} { FAILED \\ }
\CDR_int_compare:cNnF { C } = {12} { FAILED \\ }
\ExplSyntaxOff

\egroup

\subsubsection{\textsf{fancyvrb} properties}

\bgroup

\begin{CDRBlock} [
  pygments=false,
  tags=none,
  numbers=left,
  firstnumber=last,
]
A
B
C
\end{CDRBlock}

\newpage

\egroup

\subsubsection{Display tags}

\bgroup

tests start here:

%\begin{CDRBlock}[
%  tags={we are the champions,  whatever it isp},
%  fontfamily=menlo,
%  fontsize=\large,
%  pygments=true,
%  lang=lua,
%  numbers=left,
%  debug=true,
%  show tags
%]
%function foo(arg) return arg ** arg end -- tags expected
%\end{CDRBlock}

\ExplSyntaxOn
PYGMENTS: \CDR_tag_get:cc { __pygments } { pygments } \\
\ExplSyntaxOff
\CDRSet{
  tags={NONE,ENON},
  pygments=true,
  lang=lua,
  numbers=right,
  debug=true,
  show tags = none,
  firstnumber = 33,
}
\ExplSyntaxOn
PYGMENTS: \CDR_tag_get:cc { __pygments } { pygments } \\
TAGS: \CDR_tag_get:cc { default.block } { tags } \\
TAGS: \g_CDR_tags_clist \\
\ExplSyntaxOff
\begin{CDRBlock}[
  stepnumber=1,
]
function foo(arg) return 0 end
\end{CDRBlock}

\ExplSyntaxOn
NONE: \CDR_int_use:c { NONE } \\
ENON: \CDR_int_use:c { ENON } \\
\ExplSyntaxOff

\begin{CDRBlock}[
  stepnumber=1,
  firstnumber = last,
]
function foo(arg) -- no tags expected
  2
  3
  4
  5
  6
end
\end{CDRBlock}

\ExplSyntaxOn
NONE: \CDR_int_use:c { NONE } \\
ENON: \CDR_int_use:c { ENON } \\
\ExplSyntaxOff

\begin{CDRBlock}[
  stepnumber=1,
  firstnumber = auto,
]
function foo(arg) -- no tags expected
  2
  3
  4
  5
  6
end
\end{CDRBlock}
\ExplSyntaxOn
NONE: \CDR_int_use:c { NONE } \\
ENON: \CDR_int_use:c { ENON } \\
\ExplSyntaxOff

\begin{CDRBlock}[
%  tags={we are the champions,  whatever it isp},
  pygments,
  lang=lua,
  numbers=none,
  debug,
  show tags=none,
  only top=false,
]
function foo(arg) -- no tags expected
  -- second line
  -- third line
  -- fourth line
  -- fifth line
  return arg ** arg
end
\end{CDRBlock}


\begin{CDRBlock}[
%  tags={we are the champions,  whatever it isp},
  fontfamily=menlo,
  fontsize=\large,
  pygments=true,
  lang=lua,
  numbers=left,
  debug=true,
  show tags,
  only top=false
]
function foo(arg) return arg ** arg end -- tags expected
\end{CDRBlock}
\begin{CDRBlock}[
  tags={whatever it isp,we are the champions},
  fontfamily=menlo,
  fontsize=\large,
  pygments=true,
  lang=lua,
  numbers=left,
  debug=true,
  show tags,
  only top
]
function foo(arg) return arg ** arg end -- tags expected
\end{CDRBlock}
\begin{CDRBlock}[
%  tags={we are the champions,  whatever it isp},
  pygments,
  lang=lua,
  numbers=none,
  debug,
  showspaces,
  show tags=none,
  only top=false,
]
function foo(arg) -- no tags expected
  -- second line
  -- third line
  -- fourth line
  -- fifth line
  return arg ** arg
end
\end{CDRBlock}

\egroup

\subsubsection{Exhaustive test}

\bgroup

\def\CDRNumberMain{\textcolor{red}}
\def\CDRNumberOther{\textcolor{blue}}
\CDRSet {
  pygments,
  lang=lua,
  tags=WHAT,
  only top=false,
}
\begin{CDRBlock}[
        show tags=none,
        numbers=none,
        stepnumber=1
]
function foo(arg) return arg ** arg end
\end{CDRBlock}
%\egroup
%\egroup
%\endinput
\makeatletter
\def\CDR@nnn#1#2#3{
  \CDRSet {
    show tags=#1,
    numbers=#2,
    stepnumber=#3
  }
  \begin{minipage}{0.66\textwidth}
  \input{./Tests/test_single.tex}
  \vspace{0.5\baselineskip}
  \end{minipage}\\
\typeout{---------------------------------------------------------------}
  \begin{minipage}{0.66\textwidth}
  \CDRSet {
    firstnumber=last
  }
  \input{./Tests/test_more.tex}
  \vspace{0.5\baselineskip}
  \end{minipage}\\
  \begin{minipage}{0.66\textwidth}
  \CDRSet {
    pygments=false,
  }
  \input{./Tests/test_single.tex}
  \vspace{0.5\baselineskip}
  \end{minipage}\\
\typeout{---------------------------------------------------------------}
  \begin{minipage}{0.66\textwidth}
  \CDRSet {
    firstnumber=last,
    pygments=false,
  }
  \input{./Tests/test_more.tex}
  \vspace{0.5\baselineskip}
  \end{minipage}\\
}
% \def\CDR@Debug{\typeout}
\typeout{===============================================================}
\CDR@nnn{none}{none}{0}
\CDR@nnn{none}{none}{1}
\CDR@nnn{none}{none}{5}
\CDR@nnn{none}{left}{0}
\CDR@nnn{none}{left}{1}
\CDR@nnn{none}{left}{5}
\CDR@nnn{none}{right}{0}
\CDR@nnn{none}{right}{1}
\CDR@nnn{none}{right}{5}
\CDR@nnn{left}{none}{0}
\CDR@nnn{left}{none}{1}
\CDR@nnn{left}{none}{5}
\CDR@nnn{left}{left}{0}
\CDR@nnn{left}{left}{1}
\CDR@nnn{left}{left}{5}
\CDR@nnn{left}{right}{0}
\CDR@nnn{left}{right}{1}
\CDR@nnn{left}{right}{5}
\CDR@nnn{right}{none}{0}
\CDR@nnn{right}{none}{1}
\CDR@nnn{right}{none}{5}
\CDR@nnn{right}{left}{0}
\CDR@nnn{right}{left}{1}
\CDR@nnn{right}{left}{5}
\CDR@nnn{right}{right}{0}
\CDR@nnn{right}{right}{1}
\CDR@nnn{right}{right}{5}
\CDR@nnn{numbers}{none}{0}
\CDR@nnn{numbers}{none}{1}
\CDR@nnn{numbers}{none}{5}
\CDR@nnn{numbers}{left}{0}
\CDR@nnn{numbers}{left}{1}
\CDR@nnn{numbers}{left}{5}
\CDR@nnn{numbers}{right}{0}
\CDR@nnn{numbers}{right}{1}
\CDR@nnn{numbers}{right}{5}
\CDR@nnn{mirror}{none}{0}
\CDR@nnn{mirror}{none}{1}
\CDR@nnn{mirror}{none}{5}
\CDR@nnn{mirror}{left}{0}
\CDR@nnn{mirror}{left}{1}
\CDR@nnn{mirror}{left}{5}
\CDR@nnn{mirror}{right}{0}
\CDR@nnn{mirror}{right}{1}
\CDR@nnn{mirror}{right}{5}
%
% BUGGY
%\ExplSyntaxOn
%\clist_map_inline:nn { none, left, right, auto } {
%  \clist_map_inline:nn { none, left, right } {
%    \clist_map_inline:nn { 0, 1, 5 } {
%\CDR@Debug {===== SHOW_TAGS=#1}
%\CDR@Debug {===== NUMBERS=##1}
%\CDR@Debug {===== STEPNUMBER=####1}
%      \bgroup
%        \CDR@nnn { #1 } { ##1 } { ####1 }
%      \egroup
%    }
%  }
%}
%\ExplSyntaxOff
%\makeatother
%\egroup

\makeatother

\egroup
