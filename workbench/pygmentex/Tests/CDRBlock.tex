% !TeX program=lualatex
% !TeX root=../coder_test.tex
\noindent

\makeatletter

\ExplSyntaxOn


\cs_set:Npn \CDR_block_preflight:n #1 {
  \clist_if_empty:nF { #1 } {
    \par\noindent Block~options:
    \begin{itemize}
    \ttfamily
    \clist_map_inline:nn { #1 } {
      \item \tl_to_str:n { ##1 }
    }
    \end{itemize}
  }
}
\cs_set:Npn \CDR_set_preflight:n #1 {
  \clist_if_empty:nF { #1 } {
    \par\noindent CDRSet:
    \begin{itemize}
    \ttfamily
    \clist_map_inline:nn { #1 } {
      \item \tl_to_str:n { ##1 }
    }
    \end{itemize}
  }
}
%\def \CDR@Debug { \typeout }

\ExplSyntaxOff



%\bgroup
%
%%
%ESSAI
%\begin{Verbatim}
%[]
%ESSAI
%\end{Verbatim}
%
%\makeatletter
%\def\FVB@MyVerbatim{
%\FV@VerbatimBegin\FV@Scan
%}
%\def\FVE@MyVerbatim{
%\FV@VerbatimEnd
%}
%\makeatother
%\DefineVerbatimEnvironment{MyVerbatim}{MyVerbatim}{}
%
%
%\begin{MyVerbatim}[fontsize=\Large]
%ESSAI
%\end{MyVerbatim}
%
%
%\ExplSyntaxOn
%\makeatletter
%
%\cs_new:Npn \CDR_hilight_record:n #1 {
%}
%
%\def\CDR@ListProcessLine#1{%
%  \hbox to \hsize{#1
%}%
%}
%
%
%
%
%
%\cs_new:Npn \CDR@Line {
%  \peek_meaning_ignore_spaces:NTF [ { \CDR_line:nnn } { \CDR_line:nn }
%}
%\cs_new:Npn \CDR_line:nnn [ #1 ] {
%  \keys_set:nn { CDR@Line } { #1 }
%  \CDR_line:nn
%}
%\cs_new:Npn \CDR_line:nn #1 #2 {
%\CDR@Debug {CDR@Line:\the\leftmargin/#1/}
%  \hbox to \hsize {
%    \kern \leftmargin
%    \CDR_info_L:n { #1 }
%    \hbox to \linewidth {
%      \FV@LeftListFrame
%      #2
%      \hss
%      \FV@RightListFrame
%    }
%  }
%}
%
%\cs_new:Npn \CDR@NumberFormat {
%  \CDR_tag_get:c { numbers~format }
%}
%\cs_new:Npn \CDR@TagsFormat {
%  \CDR_tag_get:c { tags~format }
%}
%\cs_new:Npn \CDR@NumberSep {
%  \hspace{ \CDR_tag_get:c { numbersep } }
%}
%
%
%\ExplSyntaxOff
%
%\makeatother
%\begin{luacode}
%
%function CDR:cache_clean_unused()
%end
%
%\end{luacode}
%%
%\begin{CDRBlock}[
%  tags=,
%  fontfamily=menlo,
%  fontsize=\Large,
%  pygments=false,
%  lang=lua,
%  numbers=left,
%  frame=lines,
%  format=\color{green},
%  debug=true,
%  showspaces
%]
%local f = function(arg)
%  return arg ** arg
%end
%\end{CDRBlock}
%\CDR@Debug {IN PROGRESSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS}
%Next should not be void
%\CDRSet{cache=false}
%\begin{CDRBlock}[
%  tags=,
%  fontfamily=menlo,
%  fontsize=\large,
%  pygments=true,
%  lang=python,
%  numbers=left,
%  frame=single,
%  debug=true,
%]
%def foo(arg):
%  return arg ** arg
%\end{CDRBlock}
%
%Next should not be void
%\CDRSet{cache=false}
%\begin{CDRBlock}[
%  tags=,
%  fontfamily=menlo,
%  fontsize=\large,
%  pygments=true,
%  lang=lua,
%  numbers=left,
%  frame=lines,
%  debug=true,
%  frame=single,
%  framerule=1mm,
%  framesep=3mm,
%  rulecolor=\color{red},
%  fillcolor=\color{yellow},
%  showspaces,
%  baselinestretch=1.75
%]
%function foo(arg)
%  return arg ** arg
%end
%\end{CDRBlock}
%
%\egroup

\subsection{Line numbering}

\bgroup


\subsubsection{\textsf{fancyvrb} linear}

\bgroup

\CDRSet{pygments=false}

\begin{Verbatim} [
  numbers=none,
]
A
\end{Verbatim}

\begin{CDRBlock} [
  tags=none,
  numbers=none,
]
A
\end{CDRBlock}

\ExplSyntaxOn
\CDR_int_if_exist:cT { none } { \CDR@Debug { none ? FAILURE } }
\ExplSyntaxOff

\begin{CDRBlock} [
  tags=none,
  numbers=left,
  firstnumber=last,
]
A
B
C
\end{CDRBlock}
\ExplSyntaxOn
\CDR@Debug {tags = \g_CDR_tags_clist }
\CDR_int_if_exist:cF { none } { \CDR@Debug { none ? FAILURE } }
\CDR@Debug {none = \CDR_int_use:c { none } }
\ExplSyntaxOff

\begin{CDRBlock} [
  tags=none,
  numbers=left,
  firstnumber=last,
]
A
B
C
\end{CDRBlock}
\ExplSyntaxOn
\CDR@Debug {none = \CDR_int_use:c { none } }
\ExplSyntaxOff

\begin{CDRBlock} [
  tags=none,
  numbers=left,
  firstnumber=last,
]
A
B
C
\end{CDRBlock}
\ExplSyntaxOn
\CDR@Debug {none = \CDR_int_use:c { none }}
\ExplSyntaxOff

\egroup

\subsubsection{\textsf{fancyvrb} multi tags}

\bgroup

\CDRSet{pygments=false}

\begin{CDRBlock} [
  tags={A,B,C},
  numbers=left,
  firstnumber=last,
]
A=*1,B=1,C=1
\end{CDRBlock}

\begin{CDRBlock} [
  tags={B,C},
  numbers=left,
  firstnumber=last,
]
A=2,B=*2,C=2
A=2,B=*3,C=3
\end{CDRBlock}

\begin{CDRBlock} [
  tags=C,
  numbers=left,
  firstnumber=last,
]
A=2,B=4,C=*4
A=2,B=4,C=*5
\end{CDRBlock}

\begin{CDRBlock} [
  tags={C, B},
  numbers=left,
  firstnumber=last,
]
A=2,B=4,C=*6
A=2,B=5,C=*7
A=2,B=6,C=*8
\end{CDRBlock}

\begin{CDRBlock} [
  tags={B, A},
  numbers=left,
  firstnumber=last,
]
A=2,B=*7,C=9
A=3,B=*8,C=9
A=4,B=*9,C=9
\end{CDRBlock}
\begin{CDRBlock} [
  tags={A,C},
  numbers=left,
  firstnumber=last,
]
A=*5,B=10,C=9
A=*6,B=10,C=10
A=*7,B=10,C=11
\end{CDRBlock}

\ExplSyntaxOn
\CDR_int_compare:cNnF { A } = 8 { FAILED \\ }
\CDR_int_compare:cNnF { B } = {10} { FAILED \\ }
\CDR_int_compare:cNnF { C } = {12} { FAILED \\ }
\ExplSyntaxOff

\egroup

\subsubsection{\textsf{fancyvrb} properties}

\bgroup

\begin{CDRBlock} [
  pygments=false,
  tags=none,
  numbers=left,
  firstnumber=last,
]
A
B
C
\end{CDRBlock}

\newpage

\egroup

\subsubsection{Display tags}

\bgroup

tests start here:

%\begin{CDRBlock}[
%  tags={we are the champions,  whatever it isp},
%  fontfamily=menlo,
%  fontsize=\large,
%  pygments=true,
%  lang=lua,
%  numbers=left,
%  debug=true,
%  show tags
%]
%function foo(arg) return arg ** arg end -- tags expected
%\end{CDRBlock}

\ExplSyntaxOn
PYGMENTS: \CDR_tag_get:cc { __pygments } { pygments } \\
\ExplSyntaxOff
\CDRSet{
  tags={NONE,ENON},
  pygments=true,
  lang=lua,
  numbers=right,
  debug=true,
  show tags = none,
  firstnumber = 33,
}
\ExplSyntaxOn
PYGMENTS: \CDR_tag_get:cc { __pygments } { pygments } \\
TAGS: \CDR_tag_get:cc { default.block } { tags } \\
TAGS: \g_CDR_tags_clist \\
\ExplSyntaxOff
\begin{CDRBlock}[
  stepnumber=1,
]
function foo(arg) return 0 end
\end{CDRBlock}

\ExplSyntaxOn
NONE: \CDR_int_use:c { NONE } \\
ENON: \CDR_int_use:c { ENON } \\
\ExplSyntaxOff

\begin{CDRBlock}[
  stepnumber=1,
  firstnumber = last,
]
function foo(arg) -- no tags expected
  2
  3
  4
  5
  6
end
\end{CDRBlock}

\ExplSyntaxOn
NONE: \CDR_int_use:c { NONE } \\
ENON: \CDR_int_use:c { ENON } \\
\ExplSyntaxOff

\begin{CDRBlock}[
  stepnumber=1,
  firstnumber = auto,
]
function foo(arg) -- no tags expected
  2
  3
  4
  5
  6
end
\end{CDRBlock}
\ExplSyntaxOn
NONE: \CDR_int_use:c { NONE } \\
ENON: \CDR_int_use:c { ENON } \\
\ExplSyntaxOff

\begin{CDRBlock}[
%  tags={we are the champions,  whatever it isp},
  pygments,
  lang=lua,
  numbers=none,
  debug,
  show tags=none,
  only top=false,
]
function foo(arg) -- no tags expected
  -- second line
  -- third line
  -- fourth line
  -- fifth line
  return arg ** arg
end
\end{CDRBlock}


\begin{CDRBlock}[
%  tags={we are the champions,  whatever it isp},
  fontfamily=menlo,
  fontsize=\large,
  pygments=true,
  lang=lua,
  numbers=left,
  debug=true,
  show tags,
  only top=false
]
function foo(arg) return arg ** arg end -- tags expected
\end{CDRBlock}
\begin{CDRBlock}[
  tags={whatever it isp,we are the champions},
  fontfamily=menlo,
  fontsize=\large,
  pygments=true,
  lang=lua,
  numbers=left,
  debug=true,
  show tags,
  only top
]
function foo(arg) return arg ** arg end -- tags expected
\end{CDRBlock}
\begin{CDRBlock}[
%  tags={we are the champions,  whatever it isp},
  pygments,
  lang=lua,
  numbers=none,
  debug,
  showspaces,
  show tags=none,
  only top=false,
]
function foo(arg) -- no tags expected
  -- second line
  -- third line
  -- fourth line
  -- fifth line
  return arg ** arg
end
\end{CDRBlock}

\egroup

\subsubsection{Exhaustive test}

\bgroup

\def\CDRNumberMain{\textcolor{red}}
\def\CDRNumberOther{\textcolor{blue}}
\CDRSet {
  pygments,
  lang=lua,
  tags=WHAT,
  only top=false,
}
\begin{CDRBlock}[
        show tags=none,
        numbers=none,
        stepnumber=1
]
function foo(arg) return arg ** arg end
\end{CDRBlock}
%\egroup
%\egroup
%\endinput
\makeatletter
\def\CDR@nnn#1#2#3{
  \CDRSet {
    show tags=#1,
    numbers=#2,
    stepnumber=#3
  }
  \begin{minipage}{0.66\textwidth}
  \input{./Tests/test_single.tex}
  \vspace{0.5\baselineskip}
  \end{minipage}\\
\typeout{---------------------------------------------------------------}
  \begin{minipage}{0.66\textwidth}
  \CDRSet {
    firstnumber=last
  }
  \input{./Tests/test_more.tex}
  \vspace{0.5\baselineskip}
  \end{minipage}
}
% \def\CDR@Debug{\typeout}
\typeout{===============================================================}
\CDR@nnn{none}{none}{0}
\CDR@nnn{none}{none}{1}
\CDR@nnn{none}{none}{5}
\CDR@nnn{none}{left}{0}
\CDR@nnn{none}{left}{1}
\CDR@nnn{none}{left}{5}
\CDR@nnn{none}{right}{0}
\CDR@nnn{none}{right}{1}
\CDR@nnn{none}{right}{5}
\CDR@nnn{left}{none}{0}
\CDR@nnn{left}{none}{1}
\CDR@nnn{left}{none}{5}
\CDR@nnn{left}{left}{0}
\CDR@nnn{left}{left}{1}
\CDR@nnn{left}{left}{5}
\CDR@nnn{left}{right}{0}
\CDR@nnn{left}{right}{1}
\CDR@nnn{left}{right}{5}
\CDR@nnn{right}{none}{0}
\CDR@nnn{right}{none}{1}
\CDR@nnn{right}{none}{5}
\CDR@nnn{right}{left}{0}
\CDR@nnn{right}{left}{1}
\CDR@nnn{right}{left}{5}
\CDR@nnn{right}{right}{0}
\CDR@nnn{right}{right}{1}
\CDR@nnn{right}{right}{5}
\CDR@nnn{numbers}{none}{0}
\CDR@nnn{numbers}{none}{1}
\CDR@nnn{numbers}{none}{5}
\CDR@nnn{numbers}{left}{0}
\CDR@nnn{numbers}{left}{1}
\CDR@nnn{numbers}{left}{5}
\CDR@nnn{numbers}{right}{0}
\CDR@nnn{numbers}{right}{1}
\CDR@nnn{numbers}{right}{5}
\CDR@nnn{mirror}{none}{0}
\CDR@nnn{mirror}{none}{1}
\CDR@nnn{mirror}{none}{5}
\CDR@nnn{mirror}{left}{0}
\CDR@nnn{mirror}{left}{1}
\CDR@nnn{mirror}{left}{5}
\CDR@nnn{mirror}{right}{0}
\CDR@nnn{mirror}{right}{1}
\CDR@nnn{mirror}{right}{5}
%
% BUGGY
%\ExplSyntaxOn
%\clist_map_inline:nn { none, left, right, auto } {
%  \clist_map_inline:nn { none, left, right } {
%    \clist_map_inline:nn { 0, 1, 5 } {
%\CDR@Debug {===== SHOW_TAGS=#1}
%\CDR@Debug {===== NUMBERS=##1}
%\CDR@Debug {===== STEPNUMBER=####1}
%      \bgroup
%        \CDR@nnn { #1 } { ##1 } { ####1 }
%      \egroup
%    }
%  }
%}
%\ExplSyntaxOff
%\makeatother
%\egroup

\makeatother

\egroup
