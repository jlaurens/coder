% !TeX program=lualatex
% !TeX root=../coder_test.tex
\noindent

\bgroup

%
ESSAI
\begin{Verbatim}
[]
ESSAI
\end{Verbatim}

\makeatletter
\def\FVB@MyVerbatim{
\FV@VerbatimBegin\FV@Scan
}
\def\FVE@MyVerbatim{
\FV@VerbatimEnd
}
\makeatother
\DefineVerbatimEnvironment{MyVerbatim}{MyVerbatim}{}


\begin{MyVerbatim}[fontsize=\Large]
ESSAI
\end{MyVerbatim}


\ExplSyntaxOn
\makeatletter

\cs_new:Npn \CDR_hilight_record:n #1 {
}

\def\CDR@ListProcessLine#1{%
  \hbox to \hsize{#1
}%
}



% \begin{variable}{\l_CDR_pygments_bool}
%    \begin{MacroCode}[OK]
\bool_new:N \l_CDR_pygments_bool
\bool_set_false:N \l_CDR_pygments_bool
%    \end{MacroCode}
% \end{variable}
%

\prg_set_conditional:Nnn \CDR_if_tag_truthy:c { p, T,  F, TF } {
  \exp_args:Ne
  \str_compare:nNnTF {
    \exp_args:Ne \str_lowercase:n { \CDR_tag_get:c { #1 } }
  } = { false } {
    \prg_return_false:
  } {
    \prg_return_true:
  }
}

\def\CDR@Total#1{\typeout{TOTAL:\space#1}}


\cs_new:Npn \CDR@Line #1 #2 #3 {
  \typeout{CDR@Line:\the\leftmargin/#1/#2}
  \hbox to \hsize {
    \kern \leftmargin
    \use:c { CDR@Number#1 } { #2 }
    \hbox to \linewidth {
      \FV@LeftListFrame
      #3
      \hss
      \FV@RightListFrame
    }
  }
}

\cs_new:Npn \CDR@NumberFormat {
  \CDR_tag_get:c { numbers~format }
}
\cs_new:Npn \CDR@NumberSep {
  \hspace{ \CDR_tag_get:c { numbersep } }
}

\cs_new:Npn \CDR@NumberLeft #1 {
  \hbox_overlap_left:n {
    { \CDR@NumberFormat #1 }
    \CDR@NumberSep
  }
}
\cs_set_eq:NN \CDR@NumberSingle \CDR@NumberLeft
\cs_set_eq:NN \CDR@NumberFirst \CDR@NumberLeft
\cs_set_eq:NN \CDR@NumberSecond \CDR@NumberLeft
\cs_set_eq:NN \CDR@NumberBlack \CDR@NumberLeft
\cs_set_eq:NN \CDR@NumberWhite \CDR@NumberLeft

%    \end{MacroCode}
% \begin{function}{\FVB@CDRBlock}
% \pkg{fancyvrb} helper to begin the environment.
% \end{function}
%    \begin{MacroCode}
\def\FVB@CDRBlockX {
  \@bsphack
  \group_begin:
  \prg_set_conditional:Nnn \CDR_if_block: { p, T, F, TF } {
    \prg_return_true:
  }  
  \CDR_tag_keys_set:nn { __block } { __initialize }
%    \end{MacroCode}
% Reading the options: we absorb the options available in |\FV@KeyValues|,
% first for % \pkg{l3keys} modules, then for |\fvset|.
%    \begin{MacroCode}
  \CDR_keys_inherit:Vnn \c_CDR_tag { __local } {
    __block, __pygments.block, default.block,
    __pygments, default,
  }
  \CDR_tag_keys_set_known:nVN { __local } \FV@KeyValues \l_CDR_keyval_tl
  \CDR_tag_provide_from_keyval:V \l_CDR_keyval_tl
  \CDR_tag_keys_set_known:nVN { __local } \l_CDR_keyval_tl \l_CDR_keyval_tl
%    \end{MacroCode}
% By default, this code chunk will have the same list of tags
% as the last code block or last |\CDRExport| stored in |\g_CDR_tags_clist|.
% This can be overwritten with the |tags=...| user interface.
% At least one tag must be provided.
%    \begin{MacroCode}
  \CDR_tag_inherit:cn { __local } { default.block }
  \CDR_tag_get:cN { tags } \l_CDR_clist
  \clist_if_empty:NTF \l_CDR_clist {
    \clist_if_empty:NT \g_CDR_tags_clist {
      \PackageWarning
        { coder }
        { No~(default)~tags~provided. }
    }
  } {
    \clist_gset_eq:NN \g_CDR_tags_clist \l_CDR_clist
  }
  \lua_now:n {
    CDR:hilight_block_setup('g_CDR_tags_clist')
  }
%    \end{MacroCode}
% |\l_CDR_pygments_bool| is |true| iff one of the tags needs \pkg{pygments} or there is no tag and |pygments=true| was given.
%    \begin{MacroCode}
  \bool_set_false:N \l_CDR_pygments_bool
  \clist_if_empty:NTF \g_CDR_tags_clist {
    \bool_set:Nn \l_CDR_pygments_bool {
      \CDR_if_tag_truthy_p:c { pygments }
    }
  } {
    \bool_if:NF \l_CDR_pygments_bool {
      \clist_map_inline:Nn \g_CDR_tags_clist {
        \CDR_if_tag_truthy:ccT { ##1 } { pygments } {
          \clist_map_break:n {
            \bool_set_true:N \l_CDR_pygments_bool
          }
        }
      }
    }
  }
%    \end{MacroCode}
% Now we setup the full inheritance tree.
%    \begin{MacroCode}
  \CDR_tag_inherit:cf { __local } {
    \g_CDR_tags_clist,
    __block, default.block, __pygments.block, __fancyvrb.block, __fancyvrb.number,
     __pygments, default, __fancyvrb,
  }
  \bool_if:NTF \l_CDR_pygments_bool {
    \CDR_keys_inherit:Vnn \c_CDR_tag { __local } {
      __fancyvrb.number
    }
    \CDR_tag_keys_set_known:nVN { __local } \l_CDR_keyval_tl \l_CDR_keyval_tl
    \exp_args:NV \fvset \l_CDR_keyval_tl
    \CDR_keys_inherit:Vnn \c_CDR_tag { __local } {
      __fancyvrb, __fancyvrb.block
    }
    \exp_args:NnV
    \CDR_tag_keys_set:nn { __local } \l_CDR_keyval_tl
    \exp_args:NNV
    \def \FV@KeyValues \l_CDR_keyval_tl
%    \end{MacroCode}
% Get the list of tags and setup \CDRLua{} for recording or hilighting.
%    \begin{MacroCode}  
    \CDR_tag_get:cN {lang} \l_CDR_tl
    \lua_now:n { CDR:hilight_set_var('lang') }
    \CDR_tag_get:cN {cache} \l_CDR_tl
    \lua_now:n { CDR:hilight_set_var('cache') }
    \CDR_tag_get:cN {debug} \l_CDR_tl
    \lua_now:n { CDR:hilight_set_var('debug') }
    \CDR_tag_get:cN {style} \l_CDR_tl
    \lua_now:n { CDR:hilight_set_var('style') }
    \CDR@StyleIfExist { \l_CDR_tl } { } {
      \lua_now:n { CDR:hilight_source(true, false) }
      \input { \l_CDR_pyg_sty_tl }
    }
    \CDR@StyleUseTag
    \CDR_if_tag_truthy:cTF {no~export} {
      \clist_map_inline:nn { i, ii, iii, iv } {
        \cs_set:cpn { FV@ListProcessLine@ ##1 } ####1 {
          \tl_set:Nn \l_CDR_tl { ####1 }
          \lua_now:n { CDR:record_line('l_CDR_tl') }
        }
      }
    } {
      \clist_map_inline:nn { i, ii, iii, iv } {
        \cs_set:cpn { FV@ListProcessLine@ ##1 } ####1 {
          \tl_set:Nn \l_CDR_tl { ####1 }
          \lua_now:n { CDR:record_line('l_CDR_tl') }
        }
      }
    }
    \CDR_tag_get:cN { engine } \l_CDR_engine_tl
    \CDR_if_code_engine:VF \l_CDR_engine_tl {
      \PackageError
        { coder }
        { \l_CDR_engine_tl\space block~engine~unknown,~replaced~by~'default' }
        {See~\CDRBlockEngineNew~in~the~coder~manual}
      \tl_set:Nn \l_CDR_engine_tl { default }
    }
    \CDR_tag_get:cN { \l_CDR_engine_tl~engine~options } \l_CDR_options_tl
    \exp_args:NnV
    \use:c { \CDR_block_engine:V \l_CDR_engine_tl } \l_CDR_options_tl

    \def\FV@ProcessLine ##1 {
      \tl_set:Nn \l_CDR_tl { ##1 }
      \lua_now:n { CDR:record_line('l_CDR_tl') }
    }
  } {
    \exp_args:NNV
    \def \FV@KeyValues \l_CDR_keyval_tl
    \CDR_if_tag_truthy:cF {no~export} {
      \clist_map_inline:nn { i, ii, iii, iv } {
        \cs_set:cpn { FV@ListProcessLine@ ##1 } ####1 {
          \tl_set:Nn \l_CDR_tl { ####1 }
          \lua_now:n { CDR:record_line('l_CDR_tl') }
          \use:c { CDR@ListProcessLine@ ##1 } { ####1 }
        }
      }
    }
    \exp_args:NnV
    \use:c { \CDR_block_engine:V \l_CDR_engine_tl } \l_CDR_options_tl
    \FV@VerbatimBegin
  }
  \FV@Scan
}
\def\FVE@CDRBlockX {
  \bool_if:NT \l_CDR_pygments_bool {
    \CDR_tag_get:c { format }
    \fvset{ commandchars=\\\{\} }
    \CDR@DefineSp
    \FV@VerbatimBegin
    \lua_now:n { CDR:hilight_source(false, true) }
    \makeatletter
    \input{ \l_CDR_pyg_tex_tl }
    \makeatother
  }
  \FV@VerbatimEnd
  \use:c { end \CDR_block_engine:V \l_CDR_engine_tl }
  \group_end:
  \@esphack
}


\ExplSyntaxOff

\makeatother
\begin{luacode}

function CDR:cache_clean_unused()
end

\end{luacode}
%
\begin{CDRBlock}[
  tags=,
  fontfamily=menlo,
  fontsize=\Large,
  pygments=false,
  lang=lua,
  numbers=left,
  frame=lines,
  format=\color{green},
  debug=true,
  showspaces
]
local f = function(arg)
  return arg ** arg
end
\end{CDRBlock}
\typeout{IN PROGRESSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS}
Next should not be void
\CDRSet{cache=false}
\begin{CDRBlock}[
  tags=,
  fontfamily=menlo,
  fontsize=\large,
  pygments=true,
  lang=python,
  numbers=left,
  frame=single,
  debug=true,
]
def foo(arg):
  return arg ** arg
\end{CDRBlock}

Next should not be void
\CDRSet{cache=false}
\begin{CDRBlock}[
  tags=,
  fontfamily=menlo,
  fontsize=\large,
  pygments=true,
  lang=lua,
  numbers=left,
  frame=lines,
  debug=true,
  frame=single,
  framerule=1mm,
  framesep=3mm,
  rulecolor=\color{red},
  fillcolor=\color{yellow},
  showspaces,
  baselinestretch=1.75
]
function foo(arg)
  return arg ** arg
end
\end{CDRBlock}

\egroup

\subsection{Line numbering}

\bgroup

\makeatletter
\ExplSyntaxOn


\cs_set:Npn \CDR@NumberFormat {
  \CDR_tag_get:c { numbers~format }
}
\cs_set:Npn \CDR@NumberSep {
  \hspace{ \CDR_tag_get:c { numbersep } }
}

\cs_set:Npn \CDR@NumberLeft #1 {
  \hbox_overlap_left:n {
    { \CDR@NumberFormat #1 }
    \CDR@NumberSep
  }
}
\cs_set_eq:NN \CDR@NumberSingle \CDR@NumberLeft
\cs_set_eq:NN \CDR@NumberFirst \CDR@NumberLeft
\cs_set_eq:NN \CDR@NumberSecond \CDR@NumberLeft
\cs_set_eq:NN \CDR@NumberBlack \CDR@NumberLeft
\cs_set_eq:NN \CDR@NumberWhite \CDR@NumberLeft

%    \end{MacroCode}
% \begin{function}{\FVB@CDRBlock}
% \pkg{fancyvrb} helper to begin the environment.
% \end{function}
%    \begin{MacroCode}
\def\FVB@CDRBlock {
  \@bsphack
  \group_begin:
  \prg_set_conditional:Nnn \CDR_if_block: { p, T, F, TF } {
    \prg_return_true:
  }  
  \CDR_tag_keys_set:nn { __block } { __initialize }
%    \end{MacroCode}
% Reading the options: we absorb the options available in |\FV@KeyValues|,
% first for % \pkg{l3keys} modules, then for |\fvset|.
%    \begin{MacroCode}
  \CDR_keys_inherit:Vnn \c_CDR_tag { __local } {
    __block, __pygments.block, default.block,
    __pygments, default,
  }
  \CDR_tag_keys_set_known:nVN { __local } \FV@KeyValues \l_CDR_keyval_tl
  \CDR_tag_provide_from_keyval:V \l_CDR_keyval_tl
  \CDR_tag_keys_set_known:nVN { __local } \l_CDR_keyval_tl \l_CDR_keyval_tl
%    \end{MacroCode}
% By default, this code chunk will have the same list of tags
% as the last code block or last |\CDRExport| stored in |\g_CDR_tags_clist|.
% This can be overwritten with the |tags=...| user interface.
% At least one tag must be provided.
%    \begin{MacroCode}
  \CDR_tag_inherit:cn { __local } { default.block }
  \CDR_tag_get:cN { tags } \l_CDR_clist
  \clist_if_empty:NTF \l_CDR_clist {
    \clist_if_empty:NT \g_CDR_tags_clist {
      \PackageWarning
        { coder }
        { No~(default)~tags~provided. }
    }
  } {
    \clist_gset_eq:NN \g_CDR_tags_clist \l_CDR_clist
  }
  \lua_now:n {
    CDR:hilight_block_setup('g_CDR_tags_clist')
  }
%    \end{MacroCode}
% |\l_CDR_pygments_bool| is |true| iff one of the tags needs \pkg{pygments} or there is no tag and |pygments=true| was given.
%    \begin{MacroCode}
  \bool_set_false:N \l_CDR_pygments_bool
  \typeout{TAGS:~\g_CDR_tags_clist}
  \clist_if_empty:NTF \g_CDR_tags_clist {
    \bool_set:Nn \l_CDR_pygments_bool {
      \CDR_if_tag_truthy_p:c { pygments }
    }
  } {
    \clist_map_inline:Nn \g_CDR_tags_clist {
      \CDR_if_tag_truthy:ccT { ##1 } { pygments } {
\typeout{PYGMENTS:##1}
        \clist_map_break:n {
          \bool_set_true:N \l_CDR_pygments_bool
        }
      }
    }
  }
  \typeout{AFTER: \bool_if:NTF \l_CDR_pygments_bool TF}
%    \end{MacroCode}
% Now we setup the full inheritance tree.
%    \begin{MacroCode}
  \CDR_tag_inherit:cf { __local } {
    \g_CDR_tags_clist,
    __block, default.block, __pygments.block, __fancyvrb.block, __fancyvrb.number,
     __pygments, default, __fancyvrb,
  }
  \bool_if:NTF \l_CDR_pygments_bool {
    \CDR_keys_inherit:Vnn \c_CDR_tag { __local } {
      __fancyvrb.number
    }
    \CDR_tag_keys_set_known:nVN { __local } \l_CDR_keyval_tl \l_CDR_keyval_tl
    \exp_args:NV \fvset \l_CDR_keyval_tl
    \CDR_keys_inherit:Vnn \c_CDR_tag { __local } {
      __fancyvrb, __fancyvrb.block
    }
    \exp_args:NnV
    \CDR_tag_keys_set:nn { __local } \l_CDR_keyval_tl
    \exp_args:NNV
    \def \FV@KeyValues \l_CDR_keyval_tl
%    \end{MacroCode}
% Get the list of tags and setup \CDRLua{} for recording or hilighting.
%    \begin{MacroCode}  
    \CDR_tag_get:cN {lang} \l_CDR_tl
    \lua_now:n { CDR:hilight_set_var('lang') }
    \CDR_tag_get:cN {cache} \l_CDR_tl
    \lua_now:n { CDR:hilight_set_var('cache') }
    \CDR_tag_get:cN {debug} \l_CDR_tl
    \lua_now:n { CDR:hilight_set_var('debug') }
    \CDR_tag_get:cN {style} \l_CDR_tl
    \lua_now:n { CDR:hilight_set_var('style') }
    \CDR@StyleIfExist { \l_CDR_tl } { } {
      \lua_now:n { CDR:hilight_source(true, false) }
      \input { \l_CDR_pyg_sty_tl }
    }
    \CDR@StyleUseTag
    \CDR_if_tag_truthy:cTF {no~export} {
      \clist_map_inline:nn { i, ii, iii, iv } {
        \cs_set:cpn { FV@ListProcessLine@ ##1 } ####1 {
          \tl_set:Nn \l_CDR_tl { ####1 }
          \lua_now:n { CDR:record_line('l_CDR_tl') }
        }
      }
    } {
      \clist_map_inline:nn { i, ii, iii, iv } {
        \cs_set:cpn { FV@ListProcessLine@ ##1 } ####1 {
          \tl_set:Nn \l_CDR_tl { ####1 }
          \lua_now:n { CDR:record_line('l_CDR_tl') }
        }
      }
    }
    \CDR_tag_get:cN { engine } \l_CDR_engine_tl
    \CDR_if_code_engine:VF \l_CDR_engine_tl {
      \PackageError
        { coder }
        { \l_CDR_engine_tl\space block~engine~unknown,~replaced~by~'default' }
        {See~\CDRBlockEngineNew~in~the~coder~manual}
      \tl_set:Nn \l_CDR_engine_tl { default }
    }
    \CDR_tag_get:cN { \l_CDR_engine_tl~engine~options } \l_CDR_options_tl
    \exp_args:NnV
    \use:c { \CDR_block_engine:V \l_CDR_engine_tl } \l_CDR_options_tl

    \def\FV@ProcessLine ##1 {
      \tl_set:Nn \l_CDR_tl { ##1 }
      \lua_now:n { CDR:record_line('l_CDR_tl') }
    }
  } {
    \exp_args:NNV
    \def \FV@KeyValues \l_CDR_keyval_tl
    \typeout{FV@KeyValues=\FV@KeyValues}
    \CDR_if_tag_truthy:cF {no~export} {
      \clist_map_inline:nn { i, ii, iii, iv } {
        \cs_set:cpn { FV@ListProcessLine@ ##1 } ####1 {
          \tl_set:Nn \l_CDR_tl { ####1 }
          \lua_now:n { CDR:record_line('l_CDR_tl') }
          \use:c { CDR@ListProcessLine@ ##1 } { ####1 }
        }
      }
    }
    \exp_args:NnV
    \use:c { \CDR_block_engine:V \l_CDR_engine_tl } \l_CDR_options_tl
    \FV@VerbatimBegin
  }
  \FV@Scan
}
\def\FVE@CDRBlock {
  \bool_if:NT \l_CDR_pygments_bool {
    \CDR_tag_get:c { format }
    \fvset{ commandchars=\\\{\} }
    \CDR@DefineSp
    \FV@VerbatimBegin
    \lua_now:n { CDR:hilight_source(false, true) }
    \makeatletter
    \input{ \l_CDR_pyg_tex_tl }
    \makeatother
  }
  \FV@VerbatimEnd
  \use:c { end \CDR_block_engine:V \l_CDR_engine_tl }
  \group_end:
  \@esphack
}
\DefineVerbatimEnvironment{CDRBlock}{CDRBlock}{}
\ExplSyntaxOff
\makeatother

\subsubsection{\textsf{fancyvrb}}

\typeout{IN PROGREEEEEESSSSSSSS}
\CDRSet{pygments=false}

\begin{Verbatim} [
  numbers=none,
]
A
\end{Verbatim}

\begin{CDRBlock} [
  tags=none,
  numbers=none,
]
A
\end{CDRBlock}

\egroup


\CDRSet{pygments=false}
