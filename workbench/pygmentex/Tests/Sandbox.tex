% !TeX program=lualatex
% !TeX root=../coder_test.tex
%\CDRDebugOn
%\begin{CDRBlock}[tags=latex]
%\textbf{In eu orci massa}
%\end{CDRBlock}
\CDRDebugOn
\begin{CDRBlock}[pygments=true, show spaces = false, style=xcode, lang = lua]
function factorial(n)
  --[[Compute n!]]
  if n > 1 then
    return n * factorial(n - 1)
  end
  return 1
end
\end{CDRBlock}
\endinput
\begin{center}
\begin{tabular}{p{0.495\linewidth}|p{0.495\linewidth}}
\begin{minipage}[t]{0.9\linewidth}
\CDRBlockUse[tags=lua]{1}
\end{minipage}%
\hspace{0.09\linewidth}
&
\hspace{0.09\linewidth}%
\begin{minipage}[t]{0.8\linewidth}
\CDRBlockUse[tags=py]{2}
\end{minipage}%
\end{tabular}
\end{center}
\caption{First example}
\label{fig:First example}
\end{figure}
\end{document}

\par\noindent
POC
\begin{tabular}{p{10cm}}
\TEST[...]
\end{tabular}
\endinput
\CDRDebugOn
\begin{CDRBlock}[pygments,show spaces=false,escape inside=xyz]
  BEFOREx\textcolor{red}{RIEN}yRIENzAFTER
  BEFOREx\textcolor{red}{RIEN}yRIENzAFTER
  BEFOREx\textcolor{red}{RIEN}yRIENzAFTER
  BEFOREx\textcolor{red}{RIEN}yRIENzAFTER
\end{CDRBlock}
AFTER
\endinput

\begin{CDRBlockSave}{ABCD}
\textcolor{red}{\bfseries ABCD}
\end{CDRBlockSave}

\CDRBlockExe{ABCD}

\CDRCodeSave{ABCD}|ab  \textbf{c} de|
\def\My{a b c}
\makeatletter

\ExplSyntaxOn
\def\TEST{
  \group_begin:
  \CDRCode_peek:NN\DIDSCAN
}
\def\DIDSCAN{/WHAT\space IS\space SCANNED:\tl_to_str:V\l_CDR_peek_tl/\tl_count:N\l_CDR_peek_tl}
\ExplSyntaxOff
\makeatother
%
\bgroup
\ExplSyntaxOn
\char_set_catcode_active:n{`\ }
\ExplSyntaxOff
ab cd
\egroup
\TEST|ab㍤cde|
ab\textbf{c}de
\ExplSyntaxOn
\char_set_active_eq:nN { `\  } \FOO
\ExplSyntaxOff
\def\FOO{Y}
ab cd
\bgroup
\ExplSyntaxOn
\def\FOO{Y}
\char_set_active_eq:nN { `\c  } \FOO
\char_set_catcode_active:n{`\c }
\letc=\FOO
\ExplSyntaxOff
ab cd
\egroup
\ttfamily\\
\TEST|ab\textbf    {c}de|\\
C'est ce qui était demandé\\
\newpage
X\CDRCodeUse{ABCD}Y
X%
\CDRCodeUse[show spaces,pygments]{ABCD}%
Y%
\typeout{========}%
\CDRCode[pygments, show spaces]|AoB \textbf{C} DoE|

\CDRDebugOn
\begin{CDRBlock}
RIEN
\end{CDRBlock}
Lorem
\begin{CDRBlock} [
  pygments=false,
%  pygments,
  show spaces,
  tab size=3,
  escape inside=(),
]%  % A
RIEN2
\textbf{abcde}
    \textbf{abcde}(X \textbf{abcde} X)  \textbf{ABCDE}
	\textbf{abcde}
	(\bgroup\color{red})	(\egroup)\textbf{abcde}
\end{CDRBlock}
\lipsum[3]
Afterwards
\typeout{-------------------}
\CDRSet{pygments}
\begin{CDRBlock}
RIEN2
\def\foo#1{
  \textbf{#1}
}
\end{CDRBlock}
ABCDE
\trivlist\item ABCDE
\endtrivlist
GHJKL
\endinput

\ExplSyntaxOff
\makeatother


\endinput
%\def\baselinestretch{1}
%\begin{CDRBlockSave}{BASE}
%line 1
%physical line 2
%\physical line 3
%line 4
%line 5
%\end{CDRBlockSave}
%\CDRBlockUse[]{BASE}
%\colorlet{blackenta}{blue}
%\CDRBlockUse[
%  firstnumber=10,
%  line prefix={#1/},
%  line postfix={/#2},
%  line suffix={/#1/#2},
%]{BASE}
%\CDRBlockUse[
%  firstnumber=10,
%  line color=green!10!white,
%  text color=magenta!50!black,
%  pygments=true,
%]{BASE}
%\CDRBlockUse[
%  firstnumber=10,
%  line color=green!10!white,
%  text color=blue,
%  pygments=false,
%  line depth=0.3
%]{BASE}
%\CDRBlockUse[
%  firstnumber=10,
%  line color=\ifnumodd{#1}{green!20!white}{green!10!white},
%]{BASE}
%\CDRBlockUse[
%  firstnumber=10,
%  line color=\ifnumodd{#2}{green!20!white}{green!10!white},
%]{BASE}
%
%\CDRDebugOn
\begin{CDRBlockSave}{5 lines}
\begin{CDRBlock}[
  firstnumber=10,
  line color=\ifnumodd{#1}{green!20!white}{green!10!white},
  line prefix=\ifnumequal{#1}{2}{%
    \tikzmark{2E}%
  }{},
  line postfix=\ifnumequal{#1}{3}{%
    \tikzmark{3E}%
  }{},
  line suffix=\ifnumequal{#1}{4}{%
    \tikzmark{4E}%
  }{},
]
line 1
line 2
line 3
line 4
line 5
\end{CDRBlock}
\end{CDRBlockSave}
\CDRBlockUse[pygments]{5 lines}
\CDRBlockExe{5 lines}
The prefix of line 2 goes here\tikzmark{2B},
the postfix of line 3 goes here\tikzmark{3B}
and the suffix of line 4 goes here\tikzmark{4B}.
\begin{CDRBlockSave}{tikzpicture}
\begin{tikzpicture}[
  remember picture,
  overlay,
  -Stealth,
  very thick,
  draw opacity=0.25,
  fill opacity=0.25,
]
\draw[red!50!black] (pic cs:2B)
  ..controls ++(1.5,2.5) and ++(-1,-3.5)
  ..(pic cs:2E);
\draw[blue!50!black] (pic cs:3B)
  ..controls ++(1.5,2.5) and ++(2,0)
  ..(pic cs:3E);
\draw[green!50!black] (pic cs:4B)
  ..controls++(9,0) and ++(-0.25,-2)
  ..(pic cs:4E);
\end{tikzpicture}
\end{CDRBlockSave}
\CDRBlockExe{tikzpicture}
\CDRBlockUse[lang=tex,pygments]{tikzpicture}
\begin{luacode}
function CDR:begin_verbatim(var)
  local env_name = assert(token.get_macro(var))
  local id, error = callback.register(
    'process_input_buffer',
    function(buffer)
      return buffer
    end
  )
end
function CDR:end_verbatim()
  callback.register(
    'process_input_buffer',
    nil
  )
end
\end{luacode}
\NewDocumentEnvironment { CDR } { O{} } {
  \clist_set:Nn \l_CDR_clist { #1 }
  \directlua{ CDR:begin_verbatim('@currenv')}
} {
  \directlua{ CDR:end_verbatim()}
}
\endinput

\CDRCodeSave{ABCD}|\textbf{XYZ}|
ABCDE
\CDRCodeUse{ABCD}
GHI
\CDRCodeUse[pygments=false]{ABCD}
\endinput

\noindent

\bgroup

\makeatletter
\ExplSyntaxOn

\prg_set_conditional:Nnn \CDR_if_TEST: { p, T, F, TF } { \prg_return_true: }

T==\CDR_if_TEST:TF TF\\


\tl_set:Nn \l_CDR_a_tl { \prg_return_true: }
\exp_args:NNnV
\prg_set_conditional:Nnn \CDR_if_TEST: { p, T, F, TF } \l_CDR_a_tl

T==\CDR_if_TEST:TF TF\\


\tl_set:Nn \l_CDR_a_tl { \prg_return_true: }
\tl_put_left:Nn \l_CDR_a_tl {
\prg_set_conditional:Nnn \CDR_if_TEST: { p, T, F, TF }
}
\l_CDR_a_tl
T==\CDR_if_TEST:TF TF\\


\def\FVB@TEST {
  \@bsphack
  \FV@VerbatimBegin
  \FV@Scan
}
\def\FVE@TEST {
  \FV@VerbatimEnd
  \CDR_if_TEST:T{\typeout{T}}
  \@esphack
}

  \@namedef{TEST}{\FV@Environment{}{TEST}}
  \@namedef{endTEST}{\FVE@TEST}



\ExplSyntaxOff
\makeatother


\begin{TEST}
A
\end{TEST}

\egroup

\end{document}